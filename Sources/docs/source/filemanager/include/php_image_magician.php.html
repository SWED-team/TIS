<!doctype html>

<html lang="en">
<head>

<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="generator" content="PHPDoctor 2.0.5 (http://peej.github.com/phpdoctor/)">
<meta name="when" content="Tue, 26 Jan 2016 23:51:12 +0000">

<link rel="stylesheet" type="text/css" href="../stylesheet.css">
<link rel="start" href="../overview-summary.html">

<title>filemanager\include\php_image_magician.php (SWEDTeamTitle)</title>

</head>
<body id="file" onload="parent.document.title=document.title;">

<div class="header">
<h1>RObo cosi header</h1>
<ul>
<li><a href="../overview-summary.html">Overview</a></li>
<li>Package</li><li>Class</li><li>Tree</li><li><a href="../overview-files.html">Files</a></li>
<li><a href="../deprecated-list.html">Deprecated</a></li>
<li><a href="../todo-list.html">Todo</a></li>
<li><a href="../index-all.html">Index</a></li>
</ul>
</div>

<div class="small_links">
<a href="../index.html" target="_top">Frames</a>
<a href="../source\filemanager\include\php_image_magician.php.html" target="_top">No frames</a>
</div>
<hr>

<h1>filemanager\include\php_image_magician.php</h1>
<hr>

<a name="line1"></a><pre><?php
<a name="line2"></a># ========================================================================#
<a name="line3"></a>#
<a name="line4"></a>#  This work is licensed under the Creative Commons Attribution 3.0 Unported
<a name="line5"></a>#  License. To view a copy of this license,
<a name="line6"></a>#  visit http://creativecommons.org/licenses/by/3.0/ or send a letter to
<a name="line7"></a>#  Creative Commons, 444 Castro Street, Suite 900, Mountain View, California,
<a name="line8"></a>#  94041, USA.
<a name="line9"></a>#
<a name="line10"></a>#  All rights reserved.
<a name="line11"></a>#
<a name="line12"></a>#  Author:    Jarrod Oberto
<a name="line13"></a>#  Version:   1.5.1
<a name="line14"></a>#  Date:      10-05-11
<a name="line15"></a>#  Purpose:   Provide tools for image manipulation using GD
<a name="line16"></a>#  Param In:  See functions.
<a name="line17"></a>#  Param Out: Produces a resized image
<a name="line18"></a>#  Requires : Requires PHP GD library.
<a name="line19"></a>#  Usage Example:
<a name="line20"></a>#                     include("lib/php_image_magician.php");
<a name="line21"></a>#                     $magicianObj = new resize('images/car.jpg');
<a name="line22"></a>#                     $magicianObj -> resizeImage(150, 100, 0);
<a name="line23"></a>#                     $magicianObj -> saveImage('images/car_small.jpg', 100);
<a name="line24"></a>#
<a name="line25"></a>#        - See end of doc for more examples -
<a name="line26"></a>#
<a name="line27"></a>#  Supported file types include: jpg, png, gif, bmp, psd (read)
<a name="line28"></a>#
<a name="line29"></a>#
<a name="line30"></a>#
<a name="line31"></a>#  The following functions are taken from phpThumb() [available from
<a name="line32"></a>#    http://phpthumb.sourceforge.net], and are used with written permission
<a name="line33"></a>#  from James Heinrich.
<a name="line34"></a>#    - GD2BMPstring
<a name="line35"></a>#      - GetPixelColor
<a name="line36"></a>#      - LittleEndian2String
<a name="line37"></a>#
<a name="line38"></a>#  The following functions are from Marc Hibbins and are used with written
<a name="line39"></a>#  permission (are also under the Attribution-ShareAlike
<a name="line40"></a>#  [http://creativecommons.org/licenses/by-sa/3.0/] license.
<a name="line41"></a>#    -
<a name="line42"></a>#
<a name="line43"></a>#  PhpPsdReader is used with written permission from Tim de Koning.
<a name="line44"></a>#  [http://www.kingsquare.nl/phppsdreader]
<a name="line45"></a>#
<a name="line46"></a>#
<a name="line47"></a>#
<a name="line48"></a>#  Modificatoin history
<a name="line49"></a>#  Date      Initials  Ver Description
<a name="line50"></a>#  10-05-11  J.C.O   0.0 Initial build
<a name="line51"></a>#  01-06-11  J.C.O   0.1.1   * Added reflections
<a name="line52"></a>#              * Added Rounded corners
<a name="line53"></a>#              * You can now use PNG interlacing
<a name="line54"></a>#              * Added shadow
<a name="line55"></a>#              * Added caption box
<a name="line56"></a>#              * Added vintage filter
<a name="line57"></a>#              * Added dynamic image resizing (resize on the fly)
<a name="line58"></a>#              * minor bug fixes
<a name="line59"></a>#  05-06-11  J.C.O   0.1.1.1 * Fixed undefined variables
<a name="line60"></a>#  17-06-11  J.C.O   0.1.2   * Added image_batch_class.php class
<a name="line61"></a>#              * Minor bug fixes
<a name="line62"></a>#  26-07-11  J.C.O   0.1.4 * Added support for external images
<a name="line63"></a>#              * Can now set the crop poisition
<a name="line64"></a>#  03-08-11  J.C.O   0.1.5 * Added reset() method to reset resource to
<a name="line65"></a>#                original input file.
<a name="line66"></a>#              * Added method addTextToCaptionBox() to
<a name="line67"></a>#                simplify adding text to a caption box.
<a name="line68"></a>#              * Added experimental writeIPTC. (not finished)
<a name="line69"></a>#              * Added experimental readIPTC. (not finished)
<a name="line70"></a>#  11-08-11  J.C.O     * Added initial border presets.
<a name="line71"></a>#  30-08-11  J.C.O     * Added 'auto' crop option to crop portrait
<a name="line72"></a>#                images near the top.
<a name="line73"></a>#  08-09-11  J.C.O     * Added cropImage() method to allow standalone
<a name="line74"></a>#                cropping.
<a name="line75"></a>#  17-09-11  J.C.O     * Added setCropFromTop() set method - set the
<a name="line76"></a>#                percentage to crop from the top when using
<a name="line77"></a>#                crop 'auto' option.
<a name="line78"></a>#              * Added setTransparency() set method - allows you
<a name="line79"></a>#                to turn transparency off (like when saving
<a name="line80"></a>#                as a jpg).
<a name="line81"></a>#              * Added setFillColor() set method - set the
<a name="line82"></a>#                background color to use instead of transparency.
<a name="line83"></a>#  05-11-11  J.C.O   0.1.5.1 * Fixed interlacing option
<a name="line84"></a>#  0-07-12  J.C.O   1.0
<a name="line85"></a>#
<a name="line86"></a>#  Known issues & Limitations:
<a name="line87"></a># -------------------------------
<a name="line88"></a>#  Not so much an issue, the image is destroyed on the deconstruct rather than
<a name="line89"></a>#  when we have finished with it. The reason for this is that we don't know
<a name="line90"></a>#  when we're finished with it as you can both save the image and display
<a name="line91"></a>#  it directly to the screen (imagedestroy($this->imageResized))
<a name="line92"></a>#
<a name="line93"></a>#  Opening BMP files is slow. A test with 884 bmp files processed in a loop
<a name="line94"></a>#  takes forever - over 5 min. This test inlcuded opening the file, then
<a name="line95"></a>#  getting and displaying its width and height.
<a name="line96"></a>#
<a name="line97"></a>#  $forceStretch:
<a name="line98"></a># -------------------------------
<a name="line99"></a>#  On by default.
<a name="line100"></a>#  $forceStretch can be disabled by calling method setForceStretch with false
<a name="line101"></a>#  parameter. If disabled, if an images original size is smaller than the size
<a name="line102"></a>#  specified by the user, the original size will be used. This is useful when
<a name="line103"></a>#  dealing with small images.
<a name="line104"></a>#
<a name="line105"></a>#  If enabled, images smaller than the size specified will be stretched to
<a name="line106"></a>#  that size.
<a name="line107"></a>#
<a name="line108"></a>#  Tips:
<a name="line109"></a># -------------------------------
<a name="line110"></a>#  * If you're resizing a transparent png and saving it as a jpg, set
<a name="line111"></a>#  $keepTransparency to false with: $magicianObj->setTransparency(false);
<a name="line112"></a>#
<a name="line113"></a>#  FEATURES:
<a name="line114"></a>#    * EASY TO USE
<a name="line115"></a>#    * BMP SUPPORT (read & write)
<a name="line116"></a>#    * PSD (photoshop) support (read)
<a name="line117"></a>#    * RESIZE IMAGES
<a name="line118"></a>#      - Preserve transparency (png, gif)
<a name="line119"></a>#      - Apply sharpening (jpg) (requires PHP >= 5.1.0)
<a name="line120"></a>#      - Set image quality (jpg, png)
<a name="line121"></a>#      - Resize modes:
<a name="line122"></a>#        - exact size
<a name="line123"></a>#        - resize by width (auto height)
<a name="line124"></a>#        - resize by height (auto width)
<a name="line125"></a>#        - auto (automatically determine the best of the above modes to use)
<a name="line126"></a>#        - crop - resize as best as it can then crop the rest
<a name="line127"></a>#      - Force stretching of smaller images (upscale)
<a name="line128"></a>#    * APPLY FILTERS
<a name="line129"></a>#      - Convert to grey scale
<a name="line130"></a>#      - Convert to black and white
<a name="line131"></a>#      - Convert to sepia
<a name="line132"></a>#      - Convert to negative
<a name="line133"></a>#    * ROTATE IMAGES
<a name="line134"></a>#      - Rotate using predefined "left", "right", or "180"; or any custom degree amount
<a name="line135"></a>#    * EXTRACT EXIF DATA (requires exif module)
<a name="line136"></a>#      - make
<a name="line137"></a>#      - model
<a name="line138"></a>#      - date
<a name="line139"></a>#      - exposure
<a name="line140"></a>#      - aperture
<a name="line141"></a>#      - f-stop
<a name="line142"></a>#      - iso
<a name="line143"></a>#      - focal length
<a name="line144"></a>#      - exposure program
<a name="line145"></a>#      - metering mode
<a name="line146"></a>#      - flash status
<a name="line147"></a>#      - creator
<a name="line148"></a>#      - copyright
<a name="line149"></a>#    * ADD WATERMARK
<a name="line150"></a>#      - Specify exact x, y placement
<a name="line151"></a>#      - Or, specify using one of the 9 pre-defined placements such as "tl"
<a name="line152"></a>#        (for top left), "m" (for middle), "br" (for bottom right)
<a name="line153"></a>#        - also specify padding from edge amount (optional).
<a name="line154"></a>#      - Set opacity of watermark (png).
<a name="line155"></a>#    * ADD BORDER
<a name="line156"></a>#    * USE HEX WHEN SPECIFYING COLORS (eg: #ffffff)
<a name="line157"></a>#    * SAVE IMAGE OR OUTPUT TO SCREEN
<a name="line158"></a>#
<a name="line159"></a>#
<a name="line160"></a># ========================================================================#
<a name="line161"></a>
<a name="line162"></a>
<a name="line163"></a>class imageLib {
<a name="line164"></a>
<a name="line165"></a>	private   $fileName;
<a name="line166"></a>	private   $image;
<a name="line167"></a>	protected $imageResized;
<a name="line168"></a>	private   $widthOriginal;     # Always be the original width
<a name="line169"></a>	private   $heightOriginal;
<a name="line170"></a>	private   $width;         # Current width (width after resize)
<a name="line171"></a>	private   $height;
<a name="line172"></a>	private   $imageSize;
<a name="line173"></a>	private   $fileExtension;
<a name="line174"></a>
<a name="line175"></a>	private $debug      = true;
<a name="line176"></a>	private $errorArray = array();
<a name="line177"></a>
<a name="line178"></a>	private $forceStretch        = true;
<a name="line179"></a>	private $aggresiveSharpening = false;
<a name="line180"></a>
<a name="line181"></a>	private $transparentArray = array( '.png', '.gif' );
<a name="line182"></a>	private $keepTransparency = true;
<a name="line183"></a>	private $fillColorArray   = array( 'r' => 255, 'g' => 255, 'b' => 255 );
<a name="line184"></a>
<a name="line185"></a>	private $sharpenArray = array( 'jpg' );
<a name="line186"></a>
<a name="line187"></a>	private $psdReaderPath;
<a name="line188"></a>	private $filterOverlayPath;
<a name="line189"></a>
<a name="line190"></a>	private $isInterlace;
<a name="line191"></a>
<a name="line192"></a>	private $captionBoxPositionArray = array();
<a name="line193"></a>
<a name="line194"></a>	private $fontDir = 'fonts';
<a name="line195"></a>
<a name="line196"></a>	private $cropFromTopPercent = 10;
<a name="line197"></a>
<a name="line198"></a>
<a name="line199"></a>## --------------------------------------------------------
<a name="line200"></a>
<a name="line201"></a>	function __construct($fileName)
<a name="line202"></a>		# Author:     Jarrod Oberto
<a name="line203"></a>		# Date:     27-02-08
<a name="line204"></a>		# Purpose:    Constructor
<a name="line205"></a>		# Param in:   $fileName: File name and path.
<a name="line206"></a>		# Param out:  n/a
<a name="line207"></a>		# Reference:
<a name="line208"></a>		# Notes:
<a name="line209"></a>		#
<a name="line210"></a>	{
<a name="line211"></a>		if ( ! $this->testGDInstalled())
<a name="line212"></a>		{
<a name="line213"></a>			if ($this->debug)
<a name="line214"></a>			{
<a name="line215"></a>				throw new Exception('The GD Library is not installed.');
<a name="line216"></a>			}
<a name="line217"></a>			else
<a name="line218"></a>			{
<a name="line219"></a>				throw new Exception();
<a name="line220"></a>			}
<a name="line221"></a>		};
<a name="line222"></a>
<a name="line223"></a>		$this->initialise();
<a name="line224"></a>
<a name="line225"></a>		// *** Save the image file name. Only store this incase you want to display it
<a name="line226"></a>		$this->fileName = $fileName;
<a name="line227"></a>		$this->fileExtension = fix_strtolower(strrchr($fileName, '.'));
<a name="line228"></a>
<a name="line229"></a>		// *** Open up the file
<a name="line230"></a>		$this->image = $this->openImage($fileName);
<a name="line231"></a>
<a name="line232"></a>
<a name="line233"></a>		// *** Assign here so we don't modify the original
<a name="line234"></a>		$this->imageResized = $this->image;
<a name="line235"></a>
<a name="line236"></a>		// *** If file is an image
<a name="line237"></a>		if ($this->testIsImage($this->image))
<a name="line238"></a>		{
<a name="line239"></a>			// *** Get width and height
<a name="line240"></a>			$this->width = imagesx($this->image);
<a name="line241"></a>			$this->widthOriginal = imagesx($this->image);
<a name="line242"></a>			$this->height = imagesy($this->image);
<a name="line243"></a>			$this->heightOriginal = imagesy($this->image);
<a name="line244"></a>
<a name="line245"></a>
<a name="line246"></a>			/*  Added 15-09-08
<a name="line247"></a>         *  Get the filesize using this build in method.
<a name="line248"></a>         *  Stores an array of size
<a name="line249"></a>         *
<a name="line250"></a>         *  $this->imageSize[1] = width
<a name="line251"></a>         *  $this->imageSize[2] = height
<a name="line252"></a>         *  $this->imageSize[3] = width x height
<a name="line253"></a>         *
<a name="line254"></a>         */
<a name="line255"></a>			$this->imageSize = getimagesize($this->fileName);
<a name="line256"></a>
<a name="line257"></a>		}
<a name="line258"></a>		else
<a name="line259"></a>		{
<a name="line260"></a>			$this->errorArray[] = 'File is not an image';
<a name="line261"></a>		}
<a name="line262"></a>	}
<a name="line263"></a>
<a name="line264"></a>## --------------------------------------------------------
<a name="line265"></a>
<a name="line266"></a>	private function initialise()
<a name="line267"></a>	{
<a name="line268"></a>
<a name="line269"></a>		$this->psdReaderPath = dirname(__FILE__) . '/classPhpPsdReader.php';
<a name="line270"></a>		$this->filterOverlayPath = dirname(__FILE__) . '/filters';
<a name="line271"></a>
<a name="line272"></a>		// *** Set if image should be interlaced or not.
<a name="line273"></a>		$this->isInterlace = false;
<a name="line274"></a>	}
<a name="line275"></a>
<a name="line276"></a>
<a name="line277"></a>	/*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*-
<a name="line278"></a>  Resize
<a name="line279"></a>*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*/
<a name="line280"></a>
<a name="line281"></a>
<a name="line282"></a>	public function resizeImage($newWidth, $newHeight, $option = 0, $sharpen = false, $autoRotate = false)
<a name="line283"></a>		# Author:     Jarrod Oberto
<a name="line284"></a>		# Date:       27-02-08
<a name="line285"></a>		# Purpose:    Resizes the image
<a name="line286"></a>		# Param in:   $newWidth:
<a name="line287"></a>		#             $newHeight:
<a name="line288"></a>		#             $option:     0 / exact = defined size;
<a name="line289"></a>		#                          1 / portrait = keep aspect set height;
<a name="line290"></a>		#                          2 / landscape = keep aspect set width;
<a name="line291"></a>		#                          3 / auto = auto;
<a name="line292"></a>		#                          4 / crop= resize and crop;
<a name="line293"></a>		#
<a name="line294"></a>		#         $option can also be an array containing options for
<a name="line295"></a>		#         cropping. E.G., array('crop', 'r')
<a name="line296"></a>		#
<a name="line297"></a>		#         This array only applies to 'crop' and the 'r' refers to
<a name="line298"></a>		#         "crop right". Other value include; tl, t, tr, l, m (default),
<a name="line299"></a>		#         r, bl, b, br, or you can specify your own co-ords (which
<a name="line300"></a>		#         isn't recommended.
<a name="line301"></a>		#
<a name="line302"></a>		#       $sharpen:    true: sharpen (jpg only);
<a name="line303"></a>		#                false: don't sharpen
<a name="line304"></a>		# Param out:  n/a
<a name="line305"></a>		# Reference:
<a name="line306"></a>		# Notes:      To clarify the $option input:
<a name="line307"></a>		#               0 = The exact height and width dimensions you set.
<a name="line308"></a>		#               1 = Whatever height is passed in will be the height that
<a name="line309"></a>		#                   is set. The width will be calculated and set automatically
<a name="line310"></a>		#                   to a the value that keeps the original aspect ratio.
<a name="line311"></a>		#               2 = The same but based on the width. We try make the image the
<a name="line312"></a>		#                  biggest size we can while stil fitting inside the box size
<a name="line313"></a>		#               3 = Depending whether the image is landscape or portrait, this
<a name="line314"></a>		#                   will automatically determine whether to resize via
<a name="line315"></a>		#                   dimension 1,2 or 0
<a name="line316"></a>		#               4 = Will resize and then crop the image for best fit
<a name="line317"></a>		#
<a name="line318"></a>		#       forceStretch can be applied to options 1,2,3 and 4
<a name="line319"></a>		#
<a name="line320"></a>	{
<a name="line321"></a>
<a name="line322"></a>		// *** We can pass in an array of options to change the crop position
<a name="line323"></a>		$cropPos = 'm';
<a name="line324"></a>		if (is_array($option) && fix_strtolower($option[0]) == 'crop')
<a name="line325"></a>		{
<a name="line326"></a>			$cropPos = $option[1];         # get the crop option
<a name="line327"></a>		}
<a name="line328"></a>		else
<a name="line329"></a>		{
<a name="line330"></a>			if (strpos($option, '-') !== false)
<a name="line331"></a>			{
<a name="line332"></a>				// *** Or pass in a hyphen seperated option
<a name="line333"></a>				$optionPiecesArray = explode('-', $option);
<a name="line334"></a>				$cropPos = end($optionPiecesArray);
<a name="line335"></a>			}
<a name="line336"></a>		}
<a name="line337"></a>
<a name="line338"></a>		// *** Check the option is valid
<a name="line339"></a>		$option = $this->prepOption($option);
<a name="line340"></a>
<a name="line341"></a>		// *** Make sure the file passed in is valid
<a name="line342"></a>		if ( ! $this->image)
<a name="line343"></a>		{
<a name="line344"></a>			if ($this->debug)
<a name="line345"></a>			{
<a name="line346"></a>				throw new Exception('file ' . $this->getFileName() . ' is missing or invalid');
<a name="line347"></a>			}
<a name="line348"></a>			else
<a name="line349"></a>			{
<a name="line350"></a>				throw new Exception();
<a name="line351"></a>			}
<a name="line352"></a>		};
<a name="line353"></a>
<a name="line354"></a>		// *** Get optimal width and height - based on $option
<a name="line355"></a>		$dimensionsArray = $this->getDimensions($newWidth, $newHeight, $option);
<a name="line356"></a>
<a name="line357"></a>		$optimalWidth = $dimensionsArray['optimalWidth'];
<a name="line358"></a>		$optimalHeight = $dimensionsArray['optimalHeight'];
<a name="line359"></a>
<a name="line360"></a>		// *** Resample - create image canvas of x, y size
<a name="line361"></a>		$this->imageResized = imagecreatetruecolor($optimalWidth, $optimalHeight);
<a name="line362"></a>		$this->keepTransparancy($optimalWidth, $optimalHeight, $this->imageResized);
<a name="line363"></a>		imagecopyresampled($this->imageResized, $this->image, 0, 0, 0, 0, $optimalWidth, $optimalHeight, $this->width, $this->height);
<a name="line364"></a>
<a name="line365"></a>
<a name="line366"></a>		// *** If '4', then crop too
<a name="line367"></a>		if ($option == 4 || $option == 'crop')
<a name="line368"></a>		{
<a name="line369"></a>
<a name="line370"></a>			if (($optimalWidth >= $newWidth && $optimalHeight >= $newHeight))
<a name="line371"></a>			{
<a name="line372"></a>				$this->crop($optimalWidth, $optimalHeight, $newWidth, $newHeight, $cropPos);
<a name="line373"></a>			}
<a name="line374"></a>		}
<a name="line375"></a>
<a name="line376"></a>		// *** If Rotate.
<a name="line377"></a>		if ($autoRotate)
<a name="line378"></a>		{
<a name="line379"></a>
<a name="line380"></a>			$exifData = $this->getExif(false);
<a name="line381"></a>			if (count($exifData) > 0)
<a name="line382"></a>			{
<a name="line383"></a>
<a name="line384"></a>				switch ($exifData['orientation'])
<a name="line385"></a>				{
<a name="line386"></a>					case 8:
<a name="line387"></a>						$this->imageResized = imagerotate($this->imageResized, 90, 0);
<a name="line388"></a>						break;
<a name="line389"></a>					case 3:
<a name="line390"></a>						$this->imageResized = imagerotate($this->imageResized, 180, 0);
<a name="line391"></a>						break;
<a name="line392"></a>					case 6:
<a name="line393"></a>						$this->imageResized = imagerotate($this->imageResized, -90, 0);
<a name="line394"></a>						break;
<a name="line395"></a>				}
<a name="line396"></a>			}
<a name="line397"></a>		}
<a name="line398"></a>
<a name="line399"></a>		// *** Sharpen image (if jpg and the user wishes to do so)
<a name="line400"></a>		if ($sharpen && in_array($this->fileExtension, $this->sharpenArray))
<a name="line401"></a>		{
<a name="line402"></a>
<a name="line403"></a>			// *** Sharpen
<a name="line404"></a>			$this->sharpen();
<a name="line405"></a>		}
<a name="line406"></a>	}
<a name="line407"></a>
<a name="line408"></a>## --------------------------------------------------------
<a name="line409"></a>
<a name="line410"></a>	public function cropImage($newWidth, $newHeight, $cropPos = 'm')
<a name="line411"></a>		# Author:     Jarrod Oberto
<a name="line412"></a>		# Date:       08-09-11
<a name="line413"></a>		# Purpose:    Crops the image
<a name="line414"></a>		# Param in:   $newWidth: crop with
<a name="line415"></a>		#             $newHeight: crop height
<a name="line416"></a>		#       $cropPos: Can be any of the following:
<a name="line417"></a>		#             tl, t, tr, l, m, r, bl, b, br, auto
<a name="line418"></a>		#           Or:
<a name="line419"></a>		#             a custom position such as '30x50'
<a name="line420"></a>		# Param out:  n/a
<a name="line421"></a>		# Reference:
<a name="line422"></a>		# Notes:
<a name="line423"></a>		#
<a name="line424"></a>	{
<a name="line425"></a>
<a name="line426"></a>		// *** Make sure the file passed in is valid
<a name="line427"></a>		if ( ! $this->image)
<a name="line428"></a>		{
<a name="line429"></a>			if ($this->debug)
<a name="line430"></a>			{
<a name="line431"></a>				throw new Exception('file ' . $this->getFileName() . ' is missing or invalid');
<a name="line432"></a>			}
<a name="line433"></a>			else
<a name="line434"></a>			{
<a name="line435"></a>				throw new Exception();
<a name="line436"></a>			}
<a name="line437"></a>		};
<a name="line438"></a>
<a name="line439"></a>		$this->imageResized = $this->image;
<a name="line440"></a>		$this->crop($this->width, $this->height, $newWidth, $newHeight, $cropPos);
<a name="line441"></a>
<a name="line442"></a>	}
<a name="line443"></a>
<a name="line444"></a>## --------------------------------------------------------
<a name="line445"></a>
<a name="line446"></a>	private function keepTransparancy($width, $height, $im)
<a name="line447"></a>		# Author:     Jarrod Oberto
<a name="line448"></a>		# Date:       08-04-11
<a name="line449"></a>		# Purpose:    Keep transparency for png and gif image
<a name="line450"></a>		# Param in:
<a name="line451"></a>		# Param out:  n/a
<a name="line452"></a>		# Reference:
<a name="line453"></a>		# Notes:
<a name="line454"></a>		#
<a name="line455"></a>	{
<a name="line456"></a>		// *** If PNG, perform some transparency retention actions (gif untested)
<a name="line457"></a>		if (in_array($this->fileExtension, $this->transparentArray) && $this->keepTransparency)
<a name="line458"></a>		{
<a name="line459"></a>			imagealphablending($im, false);
<a name="line460"></a>			imagesavealpha($im, true);
<a name="line461"></a>			$transparent = imagecolorallocatealpha($im, 255, 255, 255, 127);
<a name="line462"></a>			imagefilledrectangle($im, 0, 0, $width, $height, $transparent);
<a name="line463"></a>		}
<a name="line464"></a>		else
<a name="line465"></a>		{
<a name="line466"></a>			$color = imagecolorallocate($im, $this->fillColorArray['r'], $this->fillColorArray['g'], $this->fillColorArray['b']);
<a name="line467"></a>			imagefilledrectangle($im, 0, 0, $width, $height, $color);
<a name="line468"></a>		}
<a name="line469"></a>	}
<a name="line470"></a>
<a name="line471"></a>## --------------------------------------------------------
<a name="line472"></a>
<a name="line473"></a>	private function crop($optimalWidth, $optimalHeight, $newWidth, $newHeight, $cropPos)
<a name="line474"></a>		# Author:     Jarrod Oberto
<a name="line475"></a>		# Date:       15-09-08
<a name="line476"></a>		# Purpose:    Crops the image
<a name="line477"></a>		# Param in:   $newWidth:
<a name="line478"></a>		#             $newHeight:
<a name="line479"></a>		# Param out:  n/a
<a name="line480"></a>		# Reference:
<a name="line481"></a>		# Notes:
<a name="line482"></a>		#
<a name="line483"></a>	{
<a name="line484"></a>
<a name="line485"></a>		// *** Get cropping co-ordinates
<a name="line486"></a>		$cropArray = $this->getCropPlacing($optimalWidth, $optimalHeight, $newWidth, $newHeight, $cropPos);
<a name="line487"></a>		$cropStartX = $cropArray['x'];
<a name="line488"></a>		$cropStartY = $cropArray['y'];
<a name="line489"></a>
<a name="line490"></a>		// *** Crop this bad boy
<a name="line491"></a>		$crop = imagecreatetruecolor($newWidth, $newHeight);
<a name="line492"></a>		$this->keepTransparancy($optimalWidth, $optimalHeight, $crop);
<a name="line493"></a>		imagecopyresampled($crop, $this->imageResized, 0, 0, $cropStartX, $cropStartY, $newWidth, $newHeight, $newWidth, $newHeight);
<a name="line494"></a>
<a name="line495"></a>		$this->imageResized = $crop;
<a name="line496"></a>
<a name="line497"></a>		// *** Set new width and height to our variables
<a name="line498"></a>		$this->width = $newWidth;
<a name="line499"></a>		$this->height = $newHeight;
<a name="line500"></a>
<a name="line501"></a>	}
<a name="line502"></a>
<a name="line503"></a>## --------------------------------------------------------
<a name="line504"></a>
<a name="line505"></a>	private function getCropPlacing($optimalWidth, $optimalHeight, $newWidth, $newHeight, $pos = 'm')
<a name="line506"></a>		#
<a name="line507"></a>		# Author:   Jarrod Oberto
<a name="line508"></a>		# Date:   July 11
<a name="line509"></a>		# Purpose:  Set the cropping area.
<a name="line510"></a>		# Params in:
<a name="line511"></a>		# Params out: (array) the crop x and y co-ordinates.
<a name="line512"></a>		# Notes:    When specifying the exact pixel crop position (eg 10x15), be
<a name="line513"></a>		#       very careful as it's easy to crop out of the image leaving
<a name="line514"></a>		#       black borders.
<a name="line515"></a>		#
<a name="line516"></a>	{
<a name="line517"></a>		$pos = fix_strtolower($pos);
<a name="line518"></a>
<a name="line519"></a>		// *** If co-ords have been entered
<a name="line520"></a>		if (strstr($pos, 'x'))
<a name="line521"></a>		{
<a name="line522"></a>			$pos = str_replace(' ', '', $pos);
<a name="line523"></a>
<a name="line524"></a>			$xyArray = explode('x', $pos);
<a name="line525"></a>			list($cropStartX, $cropStartY) = $xyArray;
<a name="line526"></a>
<a name="line527"></a>		}
<a name="line528"></a>		else
<a name="line529"></a>		{
<a name="line530"></a>
<a name="line531"></a>			switch ($pos)
<a name="line532"></a>			{
<a name="line533"></a>				case 'tl':
<a name="line534"></a>					$cropStartX = 0;
<a name="line535"></a>					$cropStartY = 0;
<a name="line536"></a>					break;
<a name="line537"></a>
<a name="line538"></a>				case 't':
<a name="line539"></a>					$cropStartX = ($optimalWidth / 2) - ($newWidth / 2);
<a name="line540"></a>					$cropStartY = 0;
<a name="line541"></a>					break;
<a name="line542"></a>
<a name="line543"></a>				case 'tr':
<a name="line544"></a>					$cropStartX = $optimalWidth - $newWidth;
<a name="line545"></a>					$cropStartY = 0;
<a name="line546"></a>					break;
<a name="line547"></a>
<a name="line548"></a>				case 'l':
<a name="line549"></a>					$cropStartX = 0;
<a name="line550"></a>					$cropStartY = ($optimalHeight / 2) - ($newHeight / 2);
<a name="line551"></a>					break;
<a name="line552"></a>
<a name="line553"></a>				case 'm':
<a name="line554"></a>					$cropStartX = ($optimalWidth / 2) - ($newWidth / 2);
<a name="line555"></a>					$cropStartY = ($optimalHeight / 2) - ($newHeight / 2);
<a name="line556"></a>					break;
<a name="line557"></a>
<a name="line558"></a>				case 'r':
<a name="line559"></a>					$cropStartX = $optimalWidth - $newWidth;
<a name="line560"></a>					$cropStartY = ($optimalHeight / 2) - ($newHeight / 2);
<a name="line561"></a>					break;
<a name="line562"></a>
<a name="line563"></a>				case 'bl':
<a name="line564"></a>					$cropStartX = 0;
<a name="line565"></a>					$cropStartY = $optimalHeight - $newHeight;
<a name="line566"></a>					break;
<a name="line567"></a>
<a name="line568"></a>				case 'b':
<a name="line569"></a>					$cropStartX = ($optimalWidth / 2) - ($newWidth / 2);
<a name="line570"></a>					$cropStartY = $optimalHeight - $newHeight;
<a name="line571"></a>					break;
<a name="line572"></a>
<a name="line573"></a>				case 'br':
<a name="line574"></a>					$cropStartX = $optimalWidth - $newWidth;
<a name="line575"></a>					$cropStartY = $optimalHeight - $newHeight;
<a name="line576"></a>					break;
<a name="line577"></a>
<a name="line578"></a>				case 'auto':
<a name="line579"></a>					// *** If image is a portrait crop from top, not center. v1.5
<a name="line580"></a>					if ($optimalHeight > $optimalWidth)
<a name="line581"></a>					{
<a name="line582"></a>						$cropStartX = ($optimalWidth / 2) - ($newWidth / 2);
<a name="line583"></a>						$cropStartY = ($this->cropFromTopPercent / 100) * $optimalHeight;
<a name="line584"></a>					}
<a name="line585"></a>					else
<a name="line586"></a>					{
<a name="line587"></a>
<a name="line588"></a>						// *** Else crop from the center
<a name="line589"></a>						$cropStartX = ($optimalWidth / 2) - ($newWidth / 2);
<a name="line590"></a>						$cropStartY = ($optimalHeight / 2) - ($newHeight / 2);
<a name="line591"></a>					}
<a name="line592"></a>					break;
<a name="line593"></a>
<a name="line594"></a>				default:
<a name="line595"></a>					// *** Default to center
<a name="line596"></a>					$cropStartX = ($optimalWidth / 2) - ($newWidth / 2);
<a name="line597"></a>					$cropStartY = ($optimalHeight / 2) - ($newHeight / 2);
<a name="line598"></a>					break;
<a name="line599"></a>			}
<a name="line600"></a>		}
<a name="line601"></a>
<a name="line602"></a>		return array( 'x' => $cropStartX, 'y' => $cropStartY );
<a name="line603"></a>	}
<a name="line604"></a>
<a name="line605"></a>## --------------------------------------------------------
<a name="line606"></a>
<a name="line607"></a>	private function getDimensions($newWidth, $newHeight, $option)
<a name="line608"></a>		# Author:     Jarrod Oberto
<a name="line609"></a>		# Date:       17-11-09
<a name="line610"></a>		# Purpose:    Get new image dimensions based on user specificaions
<a name="line611"></a>		# Param in:   $newWidth:
<a name="line612"></a>		#             $newHeight:
<a name="line613"></a>		# Param out:  Array of new width and height values
<a name="line614"></a>		# Reference:
<a name="line615"></a>		# Notes:    If $option = 3 then this function is call recursivly
<a name="line616"></a>		#
<a name="line617"></a>		#       To clarify the $option input:
<a name="line618"></a>		#               0 = The exact height and width dimensions you set.
<a name="line619"></a>		#               1 = Whatever height is passed in will be the height that
<a name="line620"></a>		#                   is set. The width will be calculated and set automatically
<a name="line621"></a>		#                   to a the value that keeps the original aspect ratio.
<a name="line622"></a>		#               2 = The same but based on the width.
<a name="line623"></a>		#               3 = Depending whether the image is landscape or portrait, this
<a name="line624"></a>		#                   will automatically determine whether to resize via
<a name="line625"></a>		#                   dimension 1,2 or 0.
<a name="line626"></a>		#               4 = Resize the image as much as possible, then crop the
<a name="line627"></a>		#         remainder.
<a name="line628"></a>	{
<a name="line629"></a>
<a name="line630"></a>		switch (strval($option))
<a name="line631"></a>		{
<a name="line632"></a>			case '0':
<a name="line633"></a>			case 'exact':
<a name="line634"></a>				$optimalWidth = $newWidth;
<a name="line635"></a>				$optimalHeight = $newHeight;
<a name="line636"></a>				break;
<a name="line637"></a>			case '1':
<a name="line638"></a>			case 'portrait':
<a name="line639"></a>				$dimensionsArray = $this->getSizeByFixedHeight($newWidth, $newHeight);
<a name="line640"></a>				$optimalWidth = $dimensionsArray['optimalWidth'];
<a name="line641"></a>				$optimalHeight = $dimensionsArray['optimalHeight'];
<a name="line642"></a>				break;
<a name="line643"></a>			case '2':
<a name="line644"></a>			case 'landscape':
<a name="line645"></a>				$dimensionsArray = $this->getSizeByFixedWidth($newWidth, $newHeight);
<a name="line646"></a>				$optimalWidth = $dimensionsArray['optimalWidth'];
<a name="line647"></a>				$optimalHeight = $dimensionsArray['optimalHeight'];
<a name="line648"></a>				break;
<a name="line649"></a>			case '3':
<a name="line650"></a>			case 'auto':
<a name="line651"></a>				$dimensionsArray = $this->getSizeByAuto($newWidth, $newHeight);
<a name="line652"></a>				$optimalWidth = $dimensionsArray['optimalWidth'];
<a name="line653"></a>				$optimalHeight = $dimensionsArray['optimalHeight'];
<a name="line654"></a>				break;
<a name="line655"></a>			case '4':
<a name="line656"></a>			case 'crop':
<a name="line657"></a>				$dimensionsArray = $this->getOptimalCrop($newWidth, $newHeight);
<a name="line658"></a>				$optimalWidth = $dimensionsArray['optimalWidth'];
<a name="line659"></a>				$optimalHeight = $dimensionsArray['optimalHeight'];
<a name="line660"></a>				break;
<a name="line661"></a>		}
<a name="line662"></a>
<a name="line663"></a>		return array( 'optimalWidth' => $optimalWidth, 'optimalHeight' => $optimalHeight );
<a name="line664"></a>	}
<a name="line665"></a>
<a name="line666"></a>## --------------------------------------------------------
<a name="line667"></a>
<a name="line668"></a>	private function getSizeByFixedHeight($newWidth, $newHeight)
<a name="line669"></a>	{
<a name="line670"></a>		// *** If forcing is off...
<a name="line671"></a>		if ( ! $this->forceStretch)
<a name="line672"></a>		{
<a name="line673"></a>
<a name="line674"></a>			// *** ...check if actual height is less than target height
<a name="line675"></a>			if ($this->height < $newHeight)
<a name="line676"></a>			{
<a name="line677"></a>				return array( 'optimalWidth' => $this->width, 'optimalHeight' => $this->height );
<a name="line678"></a>			}
<a name="line679"></a>		}
<a name="line680"></a>
<a name="line681"></a>		$ratio = $this->width / $this->height;
<a name="line682"></a>
<a name="line683"></a>		$newWidth = $newHeight * $ratio;
<a name="line684"></a>
<a name="line685"></a>		//return $newWidth;
<a name="line686"></a>		return array( 'optimalWidth' => $newWidth, 'optimalHeight' => $newHeight );
<a name="line687"></a>	}
<a name="line688"></a>
<a name="line689"></a>## --------------------------------------------------------
<a name="line690"></a>
<a name="line691"></a>	private function getSizeByFixedWidth($newWidth, $newHeight)
<a name="line692"></a>	{
<a name="line693"></a>		// *** If forcing is off...
<a name="line694"></a>		if ( ! $this->forceStretch)
<a name="line695"></a>		{
<a name="line696"></a>
<a name="line697"></a>			// *** ...check if actual width is less than target width
<a name="line698"></a>			if ($this->width < $newWidth)
<a name="line699"></a>			{
<a name="line700"></a>				return array( 'optimalWidth' => $this->width, 'optimalHeight' => $this->height );
<a name="line701"></a>			}
<a name="line702"></a>		}
<a name="line703"></a>
<a name="line704"></a>		$ratio = $this->height / $this->width;
<a name="line705"></a>
<a name="line706"></a>		$newHeight = $newWidth * $ratio;
<a name="line707"></a>
<a name="line708"></a>		//return $newHeight;
<a name="line709"></a>		return array( 'optimalWidth' => $newWidth, 'optimalHeight' => $newHeight );
<a name="line710"></a>	}
<a name="line711"></a>
<a name="line712"></a>## --------------------------------------------------------
<a name="line713"></a>
<a name="line714"></a>	private function getSizeByAuto($newWidth, $newHeight)
<a name="line715"></a>		# Author:     Jarrod Oberto
<a name="line716"></a>		# Date:       19-08-08
<a name="line717"></a>		# Purpose:    Depending on the height, choose to resize by 0, 1, or 2
<a name="line718"></a>		# Param in:   The new height and new width
<a name="line719"></a>		# Notes:
<a name="line720"></a>		#
<a name="line721"></a>	{
<a name="line722"></a>		// *** If forcing is off...
<a name="line723"></a>		if ( ! $this->forceStretch)
<a name="line724"></a>		{
<a name="line725"></a>
<a name="line726"></a>			// *** ...check if actual size is less than target size
<a name="line727"></a>			if ($this->width < $newWidth && $this->height < $newHeight)
<a name="line728"></a>			{
<a name="line729"></a>				return array( 'optimalWidth' => $this->width, 'optimalHeight' => $this->height );
<a name="line730"></a>			}
<a name="line731"></a>		}
<a name="line732"></a>
<a name="line733"></a>		if ($this->height < $this->width)
<a name="line734"></a>			// *** Image to be resized is wider (landscape)
<a name="line735"></a>		{
<a name="line736"></a>			//$optimalWidth = $newWidth;
<a name="line737"></a>			//$optimalHeight= $this->getSizeByFixedWidth($newWidth);
<a name="line738"></a>
<a name="line739"></a>			$dimensionsArray = $this->getSizeByFixedWidth($newWidth, $newHeight);
<a name="line740"></a>			$optimalWidth = $dimensionsArray['optimalWidth'];
<a name="line741"></a>			$optimalHeight = $dimensionsArray['optimalHeight'];
<a name="line742"></a>		}
<a name="line743"></a>		elseif ($this->height > $this->width)
<a name="line744"></a>			// *** Image to be resized is taller (portrait)
<a name="line745"></a>		{
<a name="line746"></a>			//$optimalWidth = $this->getSizeByFixedHeight($newHeight);
<a name="line747"></a>			//$optimalHeight= $newHeight;
<a name="line748"></a>
<a name="line749"></a>			$dimensionsArray = $this->getSizeByFixedHeight($newWidth, $newHeight);
<a name="line750"></a>			$optimalWidth = $dimensionsArray['optimalWidth'];
<a name="line751"></a>			$optimalHeight = $dimensionsArray['optimalHeight'];
<a name="line752"></a>		}
<a name="line753"></a>		else
<a name="line754"></a>			// *** Image to be resizerd is a square
<a name="line755"></a>		{
<a name="line756"></a>
<a name="line757"></a>			if ($newHeight < $newWidth)
<a name="line758"></a>			{
<a name="line759"></a>				//$optimalWidth = $newWidth;
<a name="line760"></a>				//$optimalHeight= $this->getSizeByFixedWidth($newWidth);
<a name="line761"></a>				$dimensionsArray = $this->getSizeByFixedWidth($newWidth, $newHeight);
<a name="line762"></a>				$optimalWidth = $dimensionsArray['optimalWidth'];
<a name="line763"></a>				$optimalHeight = $dimensionsArray['optimalHeight'];
<a name="line764"></a>			}
<a name="line765"></a>			else
<a name="line766"></a>			{
<a name="line767"></a>				if ($newHeight > $newWidth)
<a name="line768"></a>				{
<a name="line769"></a>					//$optimalWidth = $this->getSizeByFixedHeight($newHeight);
<a name="line770"></a>					//$optimalHeight= $newHeight;
<a name="line771"></a>					$dimensionsArray = $this->getSizeByFixedHeight($newWidth, $newHeight);
<a name="line772"></a>					$optimalWidth = $dimensionsArray['optimalWidth'];
<a name="line773"></a>					$optimalHeight = $dimensionsArray['optimalHeight'];
<a name="line774"></a>				}
<a name="line775"></a>				else
<a name="line776"></a>				{
<a name="line777"></a>					// *** Sqaure being resized to a square
<a name="line778"></a>					$optimalWidth = $newWidth;
<a name="line779"></a>					$optimalHeight = $newHeight;
<a name="line780"></a>				}
<a name="line781"></a>			}
<a name="line782"></a>		}
<a name="line783"></a>
<a name="line784"></a>		return array( 'optimalWidth' => $optimalWidth, 'optimalHeight' => $optimalHeight );
<a name="line785"></a>	}
<a name="line786"></a>
<a name="line787"></a>## --------------------------------------------------------
<a name="line788"></a>
<a name="line789"></a>	private function getOptimalCrop($newWidth, $newHeight)
<a name="line790"></a>		# Author:     Jarrod Oberto
<a name="line791"></a>		# Date:       17-11-09
<a name="line792"></a>		# Purpose:    Get optimal crop dimensions
<a name="line793"></a>		# Param in:   width and height as requested by user (fig 3)
<a name="line794"></a>		# Param out:  Array of optimal width and height (fig 2)
<a name="line795"></a>		# Reference:
<a name="line796"></a>		# Notes:      The optimal width and height return are not the same as the
<a name="line797"></a>		#       same as the width and height passed in. For example:
<a name="line798"></a>		#
<a name="line799"></a>		#
<a name="line800"></a>		#   |-----------------|     |------------|       |-------|
<a name="line801"></a>		#   |             |   =>  |**|      |**|   =>  |       |
<a name="line802"></a>		#   |             |     |**|      |**|       |       |
<a name="line803"></a>		#   |           |       |------------|       |-------|
<a name="line804"></a>		#   |-----------------|
<a name="line805"></a>		#        original                optimal             crop
<a name="line806"></a>		#              size                   size               size
<a name="line807"></a>		#  Fig          1                      2                  3
<a name="line808"></a>		#
<a name="line809"></a>		#       300 x 250           150 x 125          150 x 100
<a name="line810"></a>		#
<a name="line811"></a>		#    The optimal size is the smallest size (that is closest to the crop size)
<a name="line812"></a>		#    while retaining proportion/ratio.
<a name="line813"></a>		#
<a name="line814"></a>		#  The crop size is the optimal size that has been cropped on one axis to
<a name="line815"></a>		#  make the image the exact size specified by the user.
<a name="line816"></a>		#
<a name="line817"></a>		#               * represent cropped area
<a name="line818"></a>		#
<a name="line819"></a>	{
<a name="line820"></a>
<a name="line821"></a>		// *** If forcing is off...
<a name="line822"></a>		if ( ! $this->forceStretch)
<a name="line823"></a>		{
<a name="line824"></a>
<a name="line825"></a>			// *** ...check if actual size is less than target size
<a name="line826"></a>			if ($this->width < $newWidth && $this->height < $newHeight)
<a name="line827"></a>			{
<a name="line828"></a>				return array( 'optimalWidth' => $this->width, 'optimalHeight' => $this->height );
<a name="line829"></a>			}
<a name="line830"></a>		}
<a name="line831"></a>
<a name="line832"></a>		$heightRatio = $this->height / $newHeight;
<a name="line833"></a>		$widthRatio = $this->width / $newWidth;
<a name="line834"></a>
<a name="line835"></a>		if ($heightRatio < $widthRatio)
<a name="line836"></a>		{
<a name="line837"></a>			$optimalRatio = $heightRatio;
<a name="line838"></a>		}
<a name="line839"></a>		else
<a name="line840"></a>		{
<a name="line841"></a>			$optimalRatio = $widthRatio;
<a name="line842"></a>		}
<a name="line843"></a>
<a name="line844"></a>		$optimalHeight = round($this->height / $optimalRatio);
<a name="line845"></a>		$optimalWidth = round($this->width / $optimalRatio);
<a name="line846"></a>
<a name="line847"></a>		return array( 'optimalWidth' => $optimalWidth, 'optimalHeight' => $optimalHeight );
<a name="line848"></a>	}
<a name="line849"></a>
<a name="line850"></a>## --------------------------------------------------------
<a name="line851"></a>
<a name="line852"></a>	private function sharpen()
<a name="line853"></a>		# Author:     Jarrod Oberto
<a name="line854"></a>		# Date:       08 04 2011
<a name="line855"></a>		# Purpose:    Sharpen image
<a name="line856"></a>		# Param in:   n/a
<a name="line857"></a>		# Param out:  n/a
<a name="line858"></a>		# Reference:
<a name="line859"></a>		# Notes:
<a name="line860"></a>		# Credit:   Incorporates Joe Lencioni (August 6, 2008) code
<a name="line861"></a>	{
<a name="line862"></a>
<a name="line863"></a>		if (version_compare(PHP_VERSION, '5.1.0') >= 0)
<a name="line864"></a>		{
<a name="line865"></a>
<a name="line866"></a>			// ***
<a name="line867"></a>			if ($this->aggresiveSharpening)
<a name="line868"></a>			{ # A more aggressive sharpening solution
<a name="line869"></a>
<a name="line870"></a>				$sharpenMatrix = array( array( -1, -1, -1 ),
<a name="line871"></a>										array( -1, 16, -1 ),
<a name="line872"></a>										array( -1, -1, -1 ) );
<a name="line873"></a>				$divisor = 8;
<a name="line874"></a>				$offset = 0;
<a name="line875"></a>
<a name="line876"></a>				imageconvolution($this->imageResized, $sharpenMatrix, $divisor, $offset);
<a name="line877"></a>			}
<a name="line878"></a>			else # More subtle and personally more desirable
<a name="line879"></a>			{
<a name="line880"></a>				$sharpness = $this->findSharp($this->widthOriginal, $this->width);
<a name="line881"></a>
<a name="line882"></a>				$sharpenMatrix = array(
<a name="line883"></a>					array( -1, -2, -1 ),
<a name="line884"></a>					array( -2, $sharpness + 12, -2 ), //Lessen the effect of a filter by increasing the value in the center cell
<a name="line885"></a>					array( -1, -2, -1 )
<a name="line886"></a>				);
<a name="line887"></a>				$divisor = $sharpness; // adjusts brightness
<a name="line888"></a>				$offset = 0;
<a name="line889"></a>				imageconvolution($this->imageResized, $sharpenMatrix, $divisor, $offset);
<a name="line890"></a>			}
<a name="line891"></a>		}
<a name="line892"></a>		else
<a name="line893"></a>		{
<a name="line894"></a>			if ($this->debug)
<a name="line895"></a>			{
<a name="line896"></a>				throw new Exception('Sharpening required PHP 5.1.0 or greater.');
<a name="line897"></a>			}
<a name="line898"></a>		}
<a name="line899"></a>	}
<a name="line900"></a>
<a name="line901"></a>	## --------------------------------------------------------
<a name="line902"></a>
<a name="line903"></a>	private function sharpen2($level)
<a name="line904"></a>	{
<a name="line905"></a>		$sharpenMatrix = array(
<a name="line906"></a>			array( $level, $level, $level ),
<a name="line907"></a>			array( $level, (8 * $level) + 1, $level ), //Lessen the effect of a filter by increasing the value in the center cell
<a name="line908"></a>			array( $level, $level, $level )
<a name="line909"></a>		);
<a name="line910"></a>
<a name="line911"></a>	}
<a name="line912"></a>
<a name="line913"></a>## --------------------------------------------------------
<a name="line914"></a>
<a name="line915"></a>	private function findSharp($orig, $final)
<a name="line916"></a>		# Author:     Ryan Rud (http://adryrun.com)
<a name="line917"></a>		# Purpose:    Find optimal sharpness
<a name="line918"></a>		# Param in:   n/a
<a name="line919"></a>		# Param out:  n/a
<a name="line920"></a>		# Reference:
<a name="line921"></a>		# Notes:
<a name="line922"></a>		#
<a name="line923"></a>	{
<a name="line924"></a>		$final = $final * (750.0 / $orig);
<a name="line925"></a>		$a = 52;
<a name="line926"></a>		$b = -0.27810650887573124;
<a name="line927"></a>		$c = .00047337278106508946;
<a name="line928"></a>
<a name="line929"></a>		$result = $a + $b * $final + $c * $final * $final;
<a name="line930"></a>
<a name="line931"></a>		return max(round($result), 0);
<a name="line932"></a>	}
<a name="line933"></a>
<a name="line934"></a>## --------------------------------------------------------
<a name="line935"></a>
<a name="line936"></a>	private function prepOption($option)
<a name="line937"></a>		# Author:     Jarrod Oberto
<a name="line938"></a>		# Purpose:    Prep option like change the passed in option to lowercase
<a name="line939"></a>		# Param in:   (str/int) $option: eg. 'exact', 'crop'. 0, 4
<a name="line940"></a>		# Param out:  lowercase string
<a name="line941"></a>		# Reference:
<a name="line942"></a>		# Notes:
<a name="line943"></a>		#
<a name="line944"></a>	{
<a name="line945"></a>		if (is_array($option))
<a name="line946"></a>		{
<a name="line947"></a>			if (fix_strtolower($option[0]) == 'crop' && count($option) == 2)
<a name="line948"></a>			{
<a name="line949"></a>				return 'crop';
<a name="line950"></a>			}
<a name="line951"></a>			else
<a name="line952"></a>			{
<a name="line953"></a>				throw new Exception('Crop resize option array is badly formatted.');
<a name="line954"></a>			}
<a name="line955"></a>		}
<a name="line956"></a>		else
<a name="line957"></a>		{
<a name="line958"></a>			if (strpos($option, 'crop') !== false)
<a name="line959"></a>			{
<a name="line960"></a>				return 'crop';
<a name="line961"></a>			}
<a name="line962"></a>		}
<a name="line963"></a>
<a name="line964"></a>		if (is_string($option))
<a name="line965"></a>		{
<a name="line966"></a>			return fix_strtolower($option);
<a name="line967"></a>		}
<a name="line968"></a>
<a name="line969"></a>		return $option;
<a name="line970"></a>	}
<a name="line971"></a>
<a name="line972"></a>
<a name="line973"></a>	/*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*-
<a name="line974"></a>  Presets
<a name="line975"></a>*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*/
<a name="line976"></a>
<a name="line977"></a>#
<a name="line978"></a># Preset are pre-defined templates you can apply to your image.
<a name="line979"></a>#
<a name="line980"></a># These are inteded to be applied to thumbnail images.
<a name="line981"></a>#
<a name="line982"></a>
<a name="line983"></a>
<a name="line984"></a>	public function borderPreset($preset)
<a name="line985"></a>	{
<a name="line986"></a>		switch ($preset)
<a name="line987"></a>		{
<a name="line988"></a>
<a name="line989"></a>			case 'simple':
<a name="line990"></a>				$this->addBorder(7, '#fff');
<a name="line991"></a>				$this->addBorder(6, '#f2f1f0');
<a name="line992"></a>				$this->addBorder(2, '#fff');
<a name="line993"></a>				$this->addBorder(1, '#ccc');
<a name="line994"></a>				break;
<a name="line995"></a>			default:
<a name="line996"></a>				break;
<a name="line997"></a>		}
<a name="line998"></a>
<a name="line999"></a>	}
<a name="line1000"></a>
<a name="line1001"></a>
<a name="line1002"></a>	/*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*-
<a name="line1003"></a>  Draw border
<a name="line1004"></a>*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*/
<a name="line1005"></a>
<a name="line1006"></a>	public function addBorder($thickness = 1, $rgbArray = array( 255, 255, 255 ))
<a name="line1007"></a>		# Author:     Jarrod Oberto
<a name="line1008"></a>		# Date:       05-05-11
<a name="line1009"></a>		# Purpose:    Add a border to the image
<a name="line1010"></a>		# Param in:
<a name="line1011"></a>		# Param out:
<a name="line1012"></a>		# Reference:
<a name="line1013"></a>		# Notes:    This border is added to the INSIDE of the image
<a name="line1014"></a>		#
<a name="line1015"></a>	{
<a name="line1016"></a>		if ($this->imageResized)
<a name="line1017"></a>		{
<a name="line1018"></a>
<a name="line1019"></a>			$rgbArray = $this->formatColor($rgbArray);
<a name="line1020"></a>			$r = $rgbArray['r'];
<a name="line1021"></a>			$g = $rgbArray['g'];
<a name="line1022"></a>			$b = $rgbArray['b'];
<a name="line1023"></a>
<a name="line1024"></a>
<a name="line1025"></a>			$x1 = 0;
<a name="line1026"></a>			$y1 = 0;
<a name="line1027"></a>			$x2 = ImageSX($this->imageResized) - 1;
<a name="line1028"></a>			$y2 = ImageSY($this->imageResized) - 1;
<a name="line1029"></a>
<a name="line1030"></a>			$rgbArray = ImageColorAllocate($this->imageResized, $r, $g, $b);
<a name="line1031"></a>
<a name="line1032"></a>
<a name="line1033"></a>			for ($i = 0; $i < $thickness; $i++)
<a name="line1034"></a>			{
<a name="line1035"></a>				ImageRectangle($this->imageResized, $x1++, $y1++, $x2--, $y2--, $rgbArray);
<a name="line1036"></a>			}
<a name="line1037"></a>		}
<a name="line1038"></a>	}
<a name="line1039"></a>
<a name="line1040"></a>
<a name="line1041"></a>	/*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*-
<a name="line1042"></a>  Gray Scale
<a name="line1043"></a>*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*/
<a name="line1044"></a>
<a name="line1045"></a>	public function greyScale()
<a name="line1046"></a>		# Author:     Jarrod Oberto
<a name="line1047"></a>		# Date:       07-05-2011
<a name="line1048"></a>		# Purpose:    Make image greyscale
<a name="line1049"></a>		# Param in:   n/a
<a name="line1050"></a>		# Param out:
<a name="line1051"></a>		# Reference:
<a name="line1052"></a>		# Notes:
<a name="line1053"></a>		#
<a name="line1054"></a>	{
<a name="line1055"></a>		if ($this->imageResized)
<a name="line1056"></a>		{
<a name="line1057"></a>			imagefilter($this->imageResized, IMG_FILTER_GRAYSCALE);
<a name="line1058"></a>		}
<a name="line1059"></a>
<a name="line1060"></a>	}
<a name="line1061"></a>
<a name="line1062"></a>	## --------------------------------------------------------
<a name="line1063"></a>
<a name="line1064"></a>	public function greyScaleEnhanced()
<a name="line1065"></a>		# Author:     Jarrod Oberto
<a name="line1066"></a>		# Date:       07-05-2011
<a name="line1067"></a>		# Purpose:    Make image greyscale
<a name="line1068"></a>		# Param in:   n/a
<a name="line1069"></a>		# Param out:
<a name="line1070"></a>		# Reference:
<a name="line1071"></a>		# Notes:
<a name="line1072"></a>		#
<a name="line1073"></a>	{
<a name="line1074"></a>		if ($this->imageResized)
<a name="line1075"></a>		{
<a name="line1076"></a>			imagefilter($this->imageResized, IMG_FILTER_GRAYSCALE);
<a name="line1077"></a>			imagefilter($this->imageResized, IMG_FILTER_CONTRAST, -15);
<a name="line1078"></a>			imagefilter($this->imageResized, IMG_FILTER_BRIGHTNESS, 2);
<a name="line1079"></a>			$this->sharpen($this->width);
<a name="line1080"></a>		}
<a name="line1081"></a>	}
<a name="line1082"></a>
<a name="line1083"></a>	## --------------------------------------------------------
<a name="line1084"></a>
<a name="line1085"></a>	public function greyScaleDramatic()
<a name="line1086"></a>		# Alias of gd_filter_monopin
<a name="line1087"></a>	{
<a name="line1088"></a>		$this->gd_filter_monopin();
<a name="line1089"></a>	}
<a name="line1090"></a>
<a name="line1091"></a>
<a name="line1092"></a>	/*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*-
<a name="line1093"></a>  Black 'n White
<a name="line1094"></a>*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*/
<a name="line1095"></a>
<a name="line1096"></a>	public function blackAndWhite()
<a name="line1097"></a>		# Author:     Jarrod Oberto
<a name="line1098"></a>		# Date:       07-05-2011
<a name="line1099"></a>		# Purpose:    Make image black and white
<a name="line1100"></a>		# Param in:   n/a
<a name="line1101"></a>		# Param out:
<a name="line1102"></a>		# Reference:
<a name="line1103"></a>		# Notes:
<a name="line1104"></a>		#
<a name="line1105"></a>	{
<a name="line1106"></a>		if ($this->imageResized)
<a name="line1107"></a>		{
<a name="line1108"></a>
<a name="line1109"></a>			imagefilter($this->imageResized, IMG_FILTER_GRAYSCALE);
<a name="line1110"></a>			imagefilter($this->imageResized, IMG_FILTER_CONTRAST, -1000);
<a name="line1111"></a>		}
<a name="line1112"></a>
<a name="line1113"></a>	}
<a name="line1114"></a>
<a name="line1115"></a>
<a name="line1116"></a>	/*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*-
<a name="line1117"></a>  Negative
<a name="line1118"></a>*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*/
<a name="line1119"></a>
<a name="line1120"></a>	public function negative()
<a name="line1121"></a>		# Author:     Jarrod Oberto
<a name="line1122"></a>		# Date:       07-05-2011
<a name="line1123"></a>		# Purpose:    Make image negative
<a name="line1124"></a>		# Param in:   n/a
<a name="line1125"></a>		# Param out:
<a name="line1126"></a>		# Reference:
<a name="line1127"></a>		# Notes:
<a name="line1128"></a>		#
<a name="line1129"></a>	{
<a name="line1130"></a>		if ($this->imageResized)
<a name="line1131"></a>		{
<a name="line1132"></a>
<a name="line1133"></a>			imagefilter($this->imageResized, IMG_FILTER_NEGATE);
<a name="line1134"></a>		}
<a name="line1135"></a>
<a name="line1136"></a>	}
<a name="line1137"></a>
<a name="line1138"></a>
<a name="line1139"></a>	/*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*-
<a name="line1140"></a>  Sepia
<a name="line1141"></a>*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*/
<a name="line1142"></a>
<a name="line1143"></a>	public function sepia()
<a name="line1144"></a>		# Author:     Jarrod Oberto
<a name="line1145"></a>		# Date:       07-05-2011
<a name="line1146"></a>		# Purpose:    Make image sepia
<a name="line1147"></a>		# Param in:   n/a
<a name="line1148"></a>		# Param out:
<a name="line1149"></a>		# Reference:
<a name="line1150"></a>		# Notes:
<a name="line1151"></a>		#
<a name="line1152"></a>	{
<a name="line1153"></a>		if ($this->imageResized)
<a name="line1154"></a>		{
<a name="line1155"></a>			imagefilter($this->imageResized, IMG_FILTER_GRAYSCALE);
<a name="line1156"></a>			imagefilter($this->imageResized, IMG_FILTER_BRIGHTNESS, -10);
<a name="line1157"></a>			imagefilter($this->imageResized, IMG_FILTER_CONTRAST, -20);
<a name="line1158"></a>			imagefilter($this->imageResized, IMG_FILTER_COLORIZE, 60, 30, -15);
<a name="line1159"></a>		}
<a name="line1160"></a>	}
<a name="line1161"></a>
<a name="line1162"></a>	## --------------------------------------------------------
<a name="line1163"></a>
<a name="line1164"></a>	public function sepia2()
<a name="line1165"></a>
<a name="line1166"></a>	{
<a name="line1167"></a>		if ($this->imageResized)
<a name="line1168"></a>		{
<a name="line1169"></a>
<a name="line1170"></a>			$total = imagecolorstotal($this->imageResized);
<a name="line1171"></a>			for ($i = 0; $i < $total; $i++)
<a name="line1172"></a>			{
<a name="line1173"></a>				$index = imagecolorsforindex($this->imageResized, $i);
<a name="line1174"></a>				$red = ($index["red"] * 0.393 + $index["green"] * 0.769 + $index["blue"] * 0.189) / 1.351;
<a name="line1175"></a>				$green = ($index["red"] * 0.349 + $index["green"] * 0.686 + $index["blue"] * 0.168) / 1.203;
<a name="line1176"></a>				$blue = ($index["red"] * 0.272 + $index["green"] * 0.534 + $index["blue"] * 0.131) / 2.140;
<a name="line1177"></a>				imagecolorset($this->imageResized, $i, $red, $green, $blue);
<a name="line1178"></a>			}
<a name="line1179"></a>
<a name="line1180"></a>
<a name="line1181"></a>		}
<a name="line1182"></a>	}
<a name="line1183"></a>
<a name="line1184"></a>
<a name="line1185"></a>	/*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*-
<a name="line1186"></a>  Vintage
<a name="line1187"></a>*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*/
<a name="line1188"></a>
<a name="line1189"></a>	public function vintage()
<a name="line1190"></a>		# Alias of gd_filter_monopin
<a name="line1191"></a>	{
<a name="line1192"></a>		$this->gd_filter_vintage();
<a name="line1193"></a>	}
<a name="line1194"></a>
<a name="line1195"></a>	/*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*-
<a name="line1196"></a>  Presets By Marc Hibbins
<a name="line1197"></a>*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*/
<a name="line1198"></a>
<a name="line1199"></a>
<a name="line1200"></a>	/** Apply 'Monopin' preset */
<a name="line1201"></a>	public function gd_filter_monopin()
<a name="line1202"></a>	{
<a name="line1203"></a>
<a name="line1204"></a>		if ($this->imageResized)
<a name="line1205"></a>		{
<a name="line1206"></a>			imagefilter($this->imageResized, IMG_FILTER_GRAYSCALE);
<a name="line1207"></a>			imagefilter($this->imageResized, IMG_FILTER_BRIGHTNESS, -15);
<a name="line1208"></a>			imagefilter($this->imageResized, IMG_FILTER_CONTRAST, -15);
<a name="line1209"></a>			$this->imageResized = $this->gd_apply_overlay($this->imageResized, 'vignette', 100);
<a name="line1210"></a>		}
<a name="line1211"></a>	}
<a name="line1212"></a>
<a name="line1213"></a>	## --------------------------------------------------------
<a name="line1214"></a>
<a name="line1215"></a>	public function gd_filter_vintage()
<a name="line1216"></a>	{
<a name="line1217"></a>		if ($this->imageResized)
<a name="line1218"></a>		{
<a name="line1219"></a>			$this->imageResized = $this->gd_apply_overlay($this->imageResized, 'vignette', 45);
<a name="line1220"></a>			imagefilter($this->imageResized, IMG_FILTER_BRIGHTNESS, 20);
<a name="line1221"></a>			imagefilter($this->imageResized, IMG_FILTER_CONTRAST, -35);
<a name="line1222"></a>			imagefilter($this->imageResized, IMG_FILTER_COLORIZE, 60, -10, 35);
<a name="line1223"></a>			imagefilter($this->imageResized, IMG_FILTER_SMOOTH, 7);
<a name="line1224"></a>			$this->imageResized = $this->gd_apply_overlay($this->imageResized, 'scratch', 10);
<a name="line1225"></a>		}
<a name="line1226"></a>	}
<a name="line1227"></a>
<a name="line1228"></a>	## --------------------------------------------------------
<a name="line1229"></a>
<a name="line1230"></a>	/** Apply a PNG overlay */
<a name="line1231"></a>	private function gd_apply_overlay($im, $type, $amount)
<a name="line1232"></a>		#
<a name="line1233"></a>		# Original Author:    Marc Hibbins
<a name="line1234"></a>		# License:  Attribution-ShareAlike 3.0
<a name="line1235"></a>		# Purpose:
<a name="line1236"></a>		# Params in:
<a name="line1237"></a>		# Params out:
<a name="line1238"></a>		# Notes:
<a name="line1239"></a>		#
<a name="line1240"></a>	{
<a name="line1241"></a>		$width = imagesx($im);
<a name="line1242"></a>		$height = imagesy($im);
<a name="line1243"></a>		$filter = imagecreatetruecolor($width, $height);
<a name="line1244"></a>
<a name="line1245"></a>		imagealphablending($filter, false);
<a name="line1246"></a>		imagesavealpha($filter, true);
<a name="line1247"></a>
<a name="line1248"></a>		$transparent = imagecolorallocatealpha($filter, 255, 255, 255, 127);
<a name="line1249"></a>		imagefilledrectangle($filter, 0, 0, $width, $height, $transparent);
<a name="line1250"></a>
<a name="line1251"></a>		// *** Resize overlay
<a name="line1252"></a>		$overlay = $this->filterOverlayPath . '/' . $type . '.png';
<a name="line1253"></a>		$png = imagecreatefrompng($overlay);
<a name="line1254"></a>		imagecopyresampled($filter, $png, 0, 0, 0, 0, $width, $height, imagesx($png), imagesy($png));
<a name="line1255"></a>
<a name="line1256"></a>		$comp = imagecreatetruecolor($width, $height);
<a name="line1257"></a>		imagecopy($comp, $im, 0, 0, 0, 0, $width, $height);
<a name="line1258"></a>		imagecopy($comp, $filter, 0, 0, 0, 0, $width, $height);
<a name="line1259"></a>		imagecopymerge($im, $comp, 0, 0, 0, 0, $width, $height, $amount);
<a name="line1260"></a>
<a name="line1261"></a>		imagedestroy($comp);
<a name="line1262"></a>
<a name="line1263"></a>		return $im;
<a name="line1264"></a>	}
<a name="line1265"></a>
<a name="line1266"></a>
<a name="line1267"></a>	/*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*-
<a name="line1268"></a>  Colorise
<a name="line1269"></a>*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*/
<a name="line1270"></a>
<a name="line1271"></a>	public function image_colorize($rgb)
<a name="line1272"></a>	{
<a name="line1273"></a>		imageTrueColorToPalette($this->imageResized, true, 256);
<a name="line1274"></a>		$numColors = imageColorsTotal($this->imageResized);
<a name="line1275"></a>
<a name="line1276"></a>		for ($x = 0; $x < $numColors; $x++)
<a name="line1277"></a>		{
<a name="line1278"></a>			list($r, $g, $b) = array_values(imageColorsForIndex($this->imageResized, $x));
<a name="line1279"></a>
<a name="line1280"></a>			// calculate grayscale in percent
<a name="line1281"></a>			$grayscale = ($r + $g + $b) / 3 / 0xff;
<a name="line1282"></a>
<a name="line1283"></a>			imageColorSet($this->imageResized, $x,
<a name="line1284"></a>				$grayscale * $rgb[0],
<a name="line1285"></a>				$grayscale * $rgb[1],
<a name="line1286"></a>				$grayscale * $rgb[2]
<a name="line1287"></a>			);
<a name="line1288"></a>
<a name="line1289"></a>		}
<a name="line1290"></a>
<a name="line1291"></a>		return true;
<a name="line1292"></a>	}
<a name="line1293"></a>
<a name="line1294"></a>
<a name="line1295"></a>	/*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*-
<a name="line1296"></a>  Reflection
<a name="line1297"></a>*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*/
<a name="line1298"></a>
<a name="line1299"></a>	public function addReflection($reflectionHeight = 50, $startingTransparency = 30, $inside = false, $bgColor = '#fff', $stretch = false, $divider = 0)
<a name="line1300"></a>	{
<a name="line1301"></a>
<a name="line1302"></a>		// *** Convert color
<a name="line1303"></a>		$rgbArray = $this->formatColor($bgColor);
<a name="line1304"></a>		$r = $rgbArray['r'];
<a name="line1305"></a>		$g = $rgbArray['g'];
<a name="line1306"></a>		$b = $rgbArray['b'];
<a name="line1307"></a>
<a name="line1308"></a>		$im = $this->imageResized;
<a name="line1309"></a>		$li = imagecreatetruecolor($this->width, 1);
<a name="line1310"></a>
<a name="line1311"></a>		$bgc = imagecolorallocate($li, $r, $g, $b);
<a name="line1312"></a>		imagefilledrectangle($li, 0, 0, $this->width, 1, $bgc);
<a name="line1313"></a>
<a name="line1314"></a>		$bg = imagecreatetruecolor($this->width, $reflectionHeight);
<a name="line1315"></a>		$wh = imagecolorallocate($im, 255, 255, 255);
<a name="line1316"></a>
<a name="line1317"></a>		$im = imagerotate($im, -180, $wh);
<a name="line1318"></a>		imagecopyresampled($bg, $im, 0, 0, 0, 0, $this->width, $this->height, $this->width, $this->height);
<a name="line1319"></a>
<a name="line1320"></a>		$im = $bg;
<a name="line1321"></a>
<a name="line1322"></a>		$bg = imagecreatetruecolor($this->width, $reflectionHeight);
<a name="line1323"></a>
<a name="line1324"></a>		for ($x = 0; $x < $this->width; $x++)
<a name="line1325"></a>		{
<a name="line1326"></a>			imagecopy($bg, $im, $x, 0, $this->width - $x - 1, 0, 1, $reflectionHeight);
<a name="line1327"></a>		}
<a name="line1328"></a>		$im = $bg;
<a name="line1329"></a>
<a name="line1330"></a>		$transaprencyAmount = $this->invertTransparency($startingTransparency, 100);
<a name="line1331"></a>
<a name="line1332"></a>
<a name="line1333"></a>		// *** Fade
<a name="line1334"></a>		if ($stretch)
<a name="line1335"></a>		{
<a name="line1336"></a>			$step = 100 / ($reflectionHeight + $startingTransparency);
<a name="line1337"></a>		}
<a name="line1338"></a>		else
<a name="line1339"></a>		{
<a name="line1340"></a>			$step = 100 / $reflectionHeight;
<a name="line1341"></a>		}
<a name="line1342"></a>		for ($i = 0; $i <= $reflectionHeight; $i++)
<a name="line1343"></a>		{
<a name="line1344"></a>
<a name="line1345"></a>			if ($startingTransparency > 100)
<a name="line1346"></a>			{
<a name="line1347"></a>				$startingTransparency = 100;
<a name="line1348"></a>			}
<a name="line1349"></a>			if ($startingTransparency < 1)
<a name="line1350"></a>			{
<a name="line1351"></a>				$startingTransparency = 1;
<a name="line1352"></a>			}
<a name="line1353"></a>			imagecopymerge($bg, $li, 0, $i, 0, 0, $this->width, 1, $startingTransparency);
<a name="line1354"></a>			$startingTransparency += $step;
<a name="line1355"></a>		}
<a name="line1356"></a>
<a name="line1357"></a>		// *** Apply fade
<a name="line1358"></a>		imagecopymerge($im, $li, 0, 0, 0, 0, $this->width, $divider, 100); // Divider
<a name="line1359"></a>
<a name="line1360"></a>
<a name="line1361"></a>		// *** width, height of reflection.
<a name="line1362"></a>		$x = imagesx($im);
<a name="line1363"></a>		$y = imagesy($im);
<a name="line1364"></a>
<a name="line1365"></a>
<a name="line1366"></a>		// *** Determines if the reflection should be displayed inside or outside the image
<a name="line1367"></a>		if ($inside)
<a name="line1368"></a>		{
<a name="line1369"></a>
<a name="line1370"></a>			// Create new blank image with sizes.
<a name="line1371"></a>			$final = imagecreatetruecolor($this->width, $this->height);
<a name="line1372"></a>
<a name="line1373"></a>			imagecopymerge($final, $this->imageResized, 0, 0, 0, $reflectionHeight, $this->width, $this->height - $reflectionHeight, 100);
<a name="line1374"></a>			imagecopymerge($final, $im, 0, $this->height - $reflectionHeight, 0, 0, $x, $y, 100);
<a name="line1375"></a>
<a name="line1376"></a>		}
<a name="line1377"></a>		else
<a name="line1378"></a>		{
<a name="line1379"></a>
<a name="line1380"></a>			// Create new blank image with sizes.
<a name="line1381"></a>			$final = imagecreatetruecolor($this->width, $this->height + $y);
<a name="line1382"></a>
<a name="line1383"></a>			imagecopymerge($final, $this->imageResized, 0, 0, 0, 0, $this->width, $this->height, 100);
<a name="line1384"></a>			imagecopymerge($final, $im, 0, $this->height, 0, 0, $x, $y, 100);
<a name="line1385"></a>		}
<a name="line1386"></a>
<a name="line1387"></a>		$this->imageResized = $final;
<a name="line1388"></a>
<a name="line1389"></a>		imagedestroy($li);
<a name="line1390"></a>		imagedestroy($im);
<a name="line1391"></a>	}
<a name="line1392"></a>
<a name="line1393"></a>
<a name="line1394"></a>	/*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*-
<a name="line1395"></a>  Rotate
<a name="line1396"></a>*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*/
<a name="line1397"></a>
<a name="line1398"></a>	public function rotate($value = 90, $bgColor = 'transparent')
<a name="line1399"></a>		# Author:     Jarrod Oberto
<a name="line1400"></a>		# Date:       07-05-2011
<a name="line1401"></a>		# Purpose:    Rotate image
<a name="line1402"></a>		# Param in:   (mixed) $degrees: (int) number of degress to rotate image
<a name="line1403"></a>		#               (str) param "left": rotate left
<a name="line1404"></a>		#               (str) param "right": rotate right
<a name="line1405"></a>		#               (str) param "upside": upside-down image
<a name="line1406"></a>		# Param out:
<a name="line1407"></a>		# Reference:
<a name="line1408"></a>		# Notes:    The default direction of imageRotate() is counter clockwise.
<a name="line1409"></a>		#
<a name="line1410"></a>	{
<a name="line1411"></a>		if ($this->imageResized)
<a name="line1412"></a>		{
<a name="line1413"></a>
<a name="line1414"></a>			if (is_integer($value))
<a name="line1415"></a>			{
<a name="line1416"></a>				$degrees = $value;
<a name="line1417"></a>			}
<a name="line1418"></a>
<a name="line1419"></a>			// *** Convert color
<a name="line1420"></a>			$rgbArray = $this->formatColor($bgColor);
<a name="line1421"></a>			$r = $rgbArray['r'];
<a name="line1422"></a>			$g = $rgbArray['g'];
<a name="line1423"></a>			$b = $rgbArray['b'];
<a name="line1424"></a>			if (isset($rgbArray['a']))
<a name="line1425"></a>			{
<a name="line1426"></a>				$a = $rgbArray['a'];
<a name="line1427"></a>			}
<a name="line1428"></a>
<a name="line1429"></a>			if (is_string($value))
<a name="line1430"></a>			{
<a name="line1431"></a>
<a name="line1432"></a>				$value = fix_strtolower($value);
<a name="line1433"></a>
<a name="line1434"></a>				switch ($value)
<a name="line1435"></a>				{
<a name="line1436"></a>					case 'left':
<a name="line1437"></a>						$degrees = 90;
<a name="line1438"></a>						break;
<a name="line1439"></a>					case 'right':
<a name="line1440"></a>						$degrees = 270;
<a name="line1441"></a>						break;
<a name="line1442"></a>					case 'upside':
<a name="line1443"></a>						$degrees = 180;
<a name="line1444"></a>						break;
<a name="line1445"></a>					default:
<a name="line1446"></a>						break;
<a name="line1447"></a>				}
<a name="line1448"></a>
<a name="line1449"></a>			}
<a name="line1450"></a>
<a name="line1451"></a>			// *** The default direction of imageRotate() is counter clockwise
<a name="line1452"></a>			//   * This makes it clockwise
<a name="line1453"></a>			$degrees = 360 - $degrees;
<a name="line1454"></a>
<a name="line1455"></a>			// *** Create background color
<a name="line1456"></a>			$bg = ImageColorAllocateAlpha($this->imageResized, $r, $g, $b, $a);
<a name="line1457"></a>
<a name="line1458"></a>			// *** Fill with background
<a name="line1459"></a>			ImageFill($this->imageResized, 0, 0, $bg);
<a name="line1460"></a>
<a name="line1461"></a>			// *** Rotate
<a name="line1462"></a>			$this->imageResized = imagerotate($this->imageResized, $degrees, $bg); // Rotate 45 degrees and allocated the transparent colour as the one to make transparent (obviously)
<a name="line1463"></a>
<a name="line1464"></a>			// Ensure alpha transparency
<a name="line1465"></a>			ImageSaveAlpha($this->imageResized, true);
<a name="line1466"></a>
<a name="line1467"></a>		}
<a name="line1468"></a>	}
<a name="line1469"></a>
<a name="line1470"></a>
<a name="line1471"></a>	/*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*-
<a name="line1472"></a>  Round corners
<a name="line1473"></a>*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*/
<a name="line1474"></a>
<a name="line1475"></a>	public function roundCorners($radius = 5, $bgColor = 'transparent')
<a name="line1476"></a>		# Author:     Jarrod Oberto
<a name="line1477"></a>		# Date:       19-05-2011
<a name="line1478"></a>		# Purpose:    Create rounded corners on your image
<a name="line1479"></a>		# Param in:   (int) radius = the amount of curvature
<a name="line1480"></a>		#       (mixed) $bgColor = the corner background color
<a name="line1481"></a>		# Param out:  n/a
<a name="line1482"></a>		# Reference:
<a name="line1483"></a>		# Notes:
<a name="line1484"></a>		#
<a name="line1485"></a>	{
<a name="line1486"></a>
<a name="line1487"></a>		// *** Check if the user wants transparency
<a name="line1488"></a>		$isTransparent = false;
<a name="line1489"></a>		if ( ! is_array($bgColor))
<a name="line1490"></a>		{
<a name="line1491"></a>			if (fix_strtolower($bgColor) == 'transparent')
<a name="line1492"></a>			{
<a name="line1493"></a>				$isTransparent = true;
<a name="line1494"></a>			}
<a name="line1495"></a>		}
<a name="line1496"></a>
<a name="line1497"></a>
<a name="line1498"></a>		// *** If we use transparency, we need to color our curved mask with a unique color
<a name="line1499"></a>		if ($isTransparent)
<a name="line1500"></a>		{
<a name="line1501"></a>			$bgColor = $this->findUnusedGreen();
<a name="line1502"></a>		}
<a name="line1503"></a>
<a name="line1504"></a>		// *** Convert color
<a name="line1505"></a>		$rgbArray = $this->formatColor($bgColor);
<a name="line1506"></a>		$r = $rgbArray['r'];
<a name="line1507"></a>		$g = $rgbArray['g'];
<a name="line1508"></a>		$b = $rgbArray['b'];
<a name="line1509"></a>		if (isset($rgbArray['a']))
<a name="line1510"></a>		{
<a name="line1511"></a>			$a = $rgbArray['a'];
<a name="line1512"></a>		}
<a name="line1513"></a>
<a name="line1514"></a>
<a name="line1515"></a>		// *** Create top-left corner mask (square)
<a name="line1516"></a>		$cornerImg = imagecreatetruecolor($radius, $radius);
<a name="line1517"></a>		//$cornerImg = imagecreate($radius, $radius);
<a name="line1518"></a>
<a name="line1519"></a>		//imagealphablending($cornerImg, true);
<a name="line1520"></a>		//imagesavealpha($cornerImg, true);
<a name="line1521"></a>
<a name="line1522"></a>		//imagealphablending($this->imageResized, false);
<a name="line1523"></a>		//imagesavealpha($this->imageResized, true);
<a name="line1524"></a>
<a name="line1525"></a>		// *** Give it a color
<a name="line1526"></a>		$maskColor = imagecolorallocate($cornerImg, 0, 0, 0);
<a name="line1527"></a>
<a name="line1528"></a>
<a name="line1529"></a>		// *** Replace the mask color (black) to transparent
<a name="line1530"></a>		imagecolortransparent($cornerImg, $maskColor);
<a name="line1531"></a>
<a name="line1532"></a>
<a name="line1533"></a>		// *** Create the image background color
<a name="line1534"></a>		$imagebgColor = imagecolorallocate($cornerImg, $r, $g, $b);
<a name="line1535"></a>
<a name="line1536"></a>
<a name="line1537"></a>		// *** Fill the corner area to the user defined color
<a name="line1538"></a>		imagefill($cornerImg, 0, 0, $imagebgColor);
<a name="line1539"></a>
<a name="line1540"></a>
<a name="line1541"></a>		imagefilledellipse($cornerImg, $radius, $radius, $radius * 2, $radius * 2, $maskColor);
<a name="line1542"></a>
<a name="line1543"></a>
<a name="line1544"></a>		// *** Map to top left corner
<a name="line1545"></a>		imagecopymerge($this->imageResized, $cornerImg, 0, 0, 0, 0, $radius, $radius, 100); #tl
<a name="line1546"></a>
<a name="line1547"></a>		// *** Map rounded corner to other corners by rotating and applying the mask
<a name="line1548"></a>		$cornerImg = imagerotate($cornerImg, 90, 0);
<a name="line1549"></a>		imagecopymerge($this->imageResized, $cornerImg, 0, $this->height - $radius, 0, 0, $radius, $radius, 100); #bl
<a name="line1550"></a>
<a name="line1551"></a>		$cornerImg = imagerotate($cornerImg, 90, 0);
<a name="line1552"></a>		imagecopymerge($this->imageResized, $cornerImg, $this->width - $radius, $this->height - $radius, 0, 0, $radius, $radius, 100); #br
<a name="line1553"></a>
<a name="line1554"></a>		$cornerImg = imagerotate($cornerImg, 90, 0);
<a name="line1555"></a>		imagecopymerge($this->imageResized, $cornerImg, $this->width - $radius, 0, 0, 0, $radius, $radius, 100); #tr
<a name="line1556"></a>
<a name="line1557"></a>
<a name="line1558"></a>		// *** If corners are to be transparent, we fill our chromakey color as transparent.
<a name="line1559"></a>		if ($isTransparent)
<a name="line1560"></a>		{
<a name="line1561"></a>			//imagecolortransparent($this->imageResized, $imagebgColor);
<a name="line1562"></a>			$this->imageResized = $this->transparentImage($this->imageResized);
<a name="line1563"></a>			imagesavealpha($this->imageResized, true);
<a name="line1564"></a>		}
<a name="line1565"></a>
<a name="line1566"></a>	}
<a name="line1567"></a>
<a name="line1568"></a>
<a name="line1569"></a>	/*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*-
<a name="line1570"></a>  Shadow
<a name="line1571"></a>*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*/
<a name="line1572"></a>
<a name="line1573"></a>	public function addShadow($shadowAngle = 45, $blur = 15, $bgColor = 'transparent')
<a name="line1574"></a>		#
<a name="line1575"></a>		# Author:   Jarrod Oberto (Adapted from Pascal Naidon)
<a name="line1576"></a>		# Ref:    http://www.les-stooges.org/pascal/webdesign/vignettes/index.php?la=en
<a name="line1577"></a>		# Purpose:  Add a drop shadow to your image
<a name="line1578"></a>		# Params in:  (int) $angle: the angle of the shadow
<a name="line1579"></a>		#       (int) $blur: the blur distance
<a name="line1580"></a>		#       (mixed) $bgColor: the color of the background
<a name="line1581"></a>		# Params out:
<a name="line1582"></a>		# Notes:
<a name="line1583"></a>		#
<a name="line1584"></a>	{
<a name="line1585"></a>		// *** A higher number results in a smoother shadow
<a name="line1586"></a>		define('STEPS', $blur * 2);
<a name="line1587"></a>
<a name="line1588"></a>		// *** Set the shadow distance
<a name="line1589"></a>		$shadowDistance = $blur * 0.25;
<a name="line1590"></a>
<a name="line1591"></a>		// *** Set blur width and height
<a name="line1592"></a>		$blurWidth = $blurHeight = $blur;
<a name="line1593"></a>
<a name="line1594"></a>
<a name="line1595"></a>		if ($shadowAngle == 0)
<a name="line1596"></a>		{
<a name="line1597"></a>			$distWidth = 0;
<a name="line1598"></a>			$distHeight = 0;
<a name="line1599"></a>		}
<a name="line1600"></a>		else
<a name="line1601"></a>		{
<a name="line1602"></a>			$distWidth = $shadowDistance * cos(deg2rad($shadowAngle));
<a name="line1603"></a>			$distHeight = $shadowDistance * sin(deg2rad($shadowAngle));
<a name="line1604"></a>		}
<a name="line1605"></a>
<a name="line1606"></a>
<a name="line1607"></a>		// *** Convert color
<a name="line1608"></a>		if (fix_strtolower($bgColor) != 'transparent')
<a name="line1609"></a>		{
<a name="line1610"></a>			$rgbArray = $this->formatColor($bgColor);
<a name="line1611"></a>			$r0 = $rgbArray['r'];
<a name="line1612"></a>			$g0 = $rgbArray['g'];
<a name="line1613"></a>			$b0 = $rgbArray['b'];
<a name="line1614"></a>		}
<a name="line1615"></a>
<a name="line1616"></a>
<a name="line1617"></a>		$image = $this->imageResized;
<a name="line1618"></a>		$width = $this->width;
<a name="line1619"></a>		$height = $this->height;
<a name="line1620"></a>
<a name="line1621"></a>
<a name="line1622"></a>		$newImage = imagecreatetruecolor($width, $height);
<a name="line1623"></a>		imagecopyresampled($newImage, $image, 0, 0, 0, 0, $width, $height, $width, $height);
<a name="line1624"></a>
<a name="line1625"></a>
<a name="line1626"></a>		// *** RGB
<a name="line1627"></a>		$rgb = imagecreatetruecolor($width + $blurWidth, $height + $blurHeight);
<a name="line1628"></a>		$colour = imagecolorallocate($rgb, 0, 0, 0);
<a name="line1629"></a>		imagefilledrectangle($rgb, 0, 0, $width + $blurWidth, $height + $blurHeight, $colour);
<a name="line1630"></a>		$colour = imagecolorallocate($rgb, 255, 255, 255);
<a name="line1631"></a>		//imagefilledrectangle($rgb, $blurWidth*0.5-$distWidth, $blurHeight*0.5-$distHeight, $width+$blurWidth*0.5-$distWidth, $height+$blurWidth*0.5-$distHeight, $colour);
<a name="line1632"></a>		imagefilledrectangle($rgb, $blurWidth * 0.5 - $distWidth, $blurHeight * 0.5 - $distHeight, $width + $blurWidth * 0.5 - $distWidth, $height + $blurWidth * 0.5 - $distHeight, $colour);
<a name="line1633"></a>		//imagecopymerge($rgb, $newImage, 1+$blurWidth*0.5-$distWidth, 1+$blurHeight*0.5-$distHeight, 0,0, $width, $height, 100);
<a name="line1634"></a>		imagecopymerge($rgb, $newImage, $blurWidth * 0.5 - $distWidth, $blurHeight * 0.5 - $distHeight, 0, 0, $width + $blurWidth, $height + $blurHeight, 100);
<a name="line1635"></a>
<a name="line1636"></a>
<a name="line1637"></a>		// *** Shadow (alpha)
<a name="line1638"></a>		$shadow = imagecreatetruecolor($width + $blurWidth, $height + $blurHeight);
<a name="line1639"></a>		imagealphablending($shadow, false);
<a name="line1640"></a>		$colour = imagecolorallocate($shadow, 0, 0, 0);
<a name="line1641"></a>		imagefilledrectangle($shadow, 0, 0, $width + $blurWidth, $height + $blurHeight, $colour);
<a name="line1642"></a>
<a name="line1643"></a>
<a name="line1644"></a>		for ($i = 0; $i <= STEPS; $i++)
<a name="line1645"></a>		{
<a name="line1646"></a>
<a name="line1647"></a>			$t = ((1.0 * $i) / STEPS);
<a name="line1648"></a>			$intensity = 255 * $t * $t;
<a name="line1649"></a>
<a name="line1650"></a>			$colour = imagecolorallocate($shadow, $intensity, $intensity, $intensity);
<a name="line1651"></a>			$points = array(
<a name="line1652"></a>				$blurWidth * $t, $blurHeight,     // Point 1 (x, y)
<a name="line1653"></a>				$blurWidth, $blurHeight * $t,  // Point 2 (x, y)
<a name="line1654"></a>				$width, $blurHeight * $t,  // Point 3 (x, y)
<a name="line1655"></a>				$width + $blurWidth * (1 - $t), $blurHeight,     // Point 4 (x, y)
<a name="line1656"></a>				$width + $blurWidth * (1 - $t), $height,     // Point 5 (x, y)
<a name="line1657"></a>				$width, $height + $blurHeight * (1 - $t),  // Point 6 (x, y)
<a name="line1658"></a>				$blurWidth, $height + $blurHeight * (1 - $t),  // Point 7 (x, y)
<a name="line1659"></a>				$blurWidth * $t, $height      // Point 8 (x, y)
<a name="line1660"></a>			);
<a name="line1661"></a>			imagepolygon($shadow, $points, 8, $colour);
<a name="line1662"></a>		}
<a name="line1663"></a>
<a name="line1664"></a>		for ($i = 0; $i <= STEPS; $i++)
<a name="line1665"></a>		{
<a name="line1666"></a>
<a name="line1667"></a>			$t = ((1.0 * $i) / STEPS);
<a name="line1668"></a>			$intensity = 255 * $t * $t;
<a name="line1669"></a>
<a name="line1670"></a>			$colour = imagecolorallocate($shadow, $intensity, $intensity, $intensity);
<a name="line1671"></a>			imagefilledarc($shadow, $blurWidth - 1, $blurHeight - 1, 2 * (1 - $t) * $blurWidth, 2 * (1 - $t) * $blurHeight, 180, 268, $colour, IMG_ARC_PIE);
<a name="line1672"></a>			imagefilledarc($shadow, $width, $blurHeight - 1, 2 * (1 - $t) * $blurWidth, 2 * (1 - $t) * $blurHeight, 270, 358, $colour, IMG_ARC_PIE);
<a name="line1673"></a>			imagefilledarc($shadow, $width, $height, 2 * (1 - $t) * $blurWidth, 2 * (1 - $t) * $blurHeight, 0, 90, $colour, IMG_ARC_PIE);
<a name="line1674"></a>			imagefilledarc($shadow, $blurWidth - 1, $height, 2 * (1 - $t) * $blurWidth, 2 * (1 - $t) * $blurHeight, 90, 180, $colour, IMG_ARC_PIE);
<a name="line1675"></a>		}
<a name="line1676"></a>
<a name="line1677"></a>
<a name="line1678"></a>		$colour = imagecolorallocate($shadow, 255, 255, 255);
<a name="line1679"></a>		imagefilledrectangle($shadow, $blurWidth, $blurHeight, $width, $height, $colour);
<a name="line1680"></a>		imagefilledrectangle($shadow, $blurWidth * 0.5 - $distWidth, $blurHeight * 0.5 - $distHeight, $width + $blurWidth * 0.5 - 1 - $distWidth, $height + $blurHeight * 0.5 - 1 - $distHeight, $colour);
<a name="line1681"></a>
<a name="line1682"></a>
<a name="line1683"></a>		// *** The magic
<a name="line1684"></a>		imagealphablending($rgb, false);
<a name="line1685"></a>
<a name="line1686"></a>		for ($theX = 0; $theX < imagesx($rgb); $theX++)
<a name="line1687"></a>		{
<a name="line1688"></a>			for ($theY = 0; $theY < imagesy($rgb); $theY++)
<a name="line1689"></a>			{
<a name="line1690"></a>
<a name="line1691"></a>				// *** Get the RGB values for every pixel of the RGB image
<a name="line1692"></a>				$colArray = imagecolorat($rgb, $theX, $theY);
<a name="line1693"></a>				$r = ($colArray >> 16) & 0xFF;
<a name="line1694"></a>				$g = ($colArray >> 8) & 0xFF;
<a name="line1695"></a>				$b = $colArray & 0xFF;
<a name="line1696"></a>
<a name="line1697"></a>				// *** Get the alpha value for every pixel of the shadow image
<a name="line1698"></a>				$colArray = imagecolorat($shadow, $theX, $theY);
<a name="line1699"></a>				$a = $colArray & 0xFF;
<a name="line1700"></a>				$a = 127 - floor($a / 2);
<a name="line1701"></a>				$t = $a / 128.0;
<a name="line1702"></a>
<a name="line1703"></a>				// *** Create color
<a name="line1704"></a>				if (fix_strtolower($bgColor) == 'transparent')
<a name="line1705"></a>				{
<a name="line1706"></a>					$myColour = imagecolorallocatealpha($rgb, $r, $g, $b, $a);
<a name="line1707"></a>				}
<a name="line1708"></a>				else
<a name="line1709"></a>				{
<a name="line1710"></a>					$myColour = imagecolorallocate($rgb, $r * (1.0 - $t) + $r0 * $t, $g * (1.0 - $t) + $g0 * $t, $b * (1.0 - $t) + $b0 * $t);
<a name="line1711"></a>				}
<a name="line1712"></a>
<a name="line1713"></a>				// *** Add color to new rgb image
<a name="line1714"></a>				imagesetpixel($rgb, $theX, $theY, $myColour);
<a name="line1715"></a>			}
<a name="line1716"></a>		}
<a name="line1717"></a>
<a name="line1718"></a>		imagealphablending($rgb, true);
<a name="line1719"></a>		imagesavealpha($rgb, true);
<a name="line1720"></a>
<a name="line1721"></a>		$this->imageResized = $rgb;
<a name="line1722"></a>
<a name="line1723"></a>		imagedestroy($image);
<a name="line1724"></a>		imagedestroy($newImage);
<a name="line1725"></a>		imagedestroy($shadow);
<a name="line1726"></a>	}
<a name="line1727"></a>
<a name="line1728"></a>
<a name="line1729"></a>	/*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*-
<a name="line1730"></a>  Add Caption Box
<a name="line1731"></a>*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*/
<a name="line1732"></a>
<a name="line1733"></a>	public function addCaptionBox($side = 'b', $thickness = 50, $padding = 0, $bgColor = '#000', $transaprencyAmount = 30)
<a name="line1734"></a>		#
<a name="line1735"></a>		# Author:   Jarrod Oberto
<a name="line1736"></a>		# Date:   26 May 2011
<a name="line1737"></a>		# Purpose:  Add a caption box
<a name="line1738"></a>		# Params in:  (str) $side: the side to add the caption box (t, r, b, or l).
<a name="line1739"></a>		#       (int) $thickness: how thick you want the caption box to be.
<a name="line1740"></a>		#       (mixed) $bgColor: The color of the caption box.
<a name="line1741"></a>		#       (int) $transaprencyAmount: The amount of transparency to be
<a name="line1742"></a>		#       applied.
<a name="line1743"></a>		# Params out: n/a
<a name="line1744"></a>		# Notes:
<a name="line1745"></a>		#
<a name="line1746"></a>	{
<a name="line1747"></a>		$side = fix_strtolower($side);
<a name="line1748"></a>
<a name="line1749"></a>		// *** Convert color
<a name="line1750"></a>		$rgbArray = $this->formatColor($bgColor);
<a name="line1751"></a>		$r = $rgbArray['r'];
<a name="line1752"></a>		$g = $rgbArray['g'];
<a name="line1753"></a>		$b = $rgbArray['b'];
<a name="line1754"></a>
<a name="line1755"></a>		$positionArray = $this->calculateCaptionBoxPosition($side, $thickness, $padding);
<a name="line1756"></a>
<a name="line1757"></a>		// *** Store incase we want to use method addTextToCaptionBox()
<a name="line1758"></a>		$this->captionBoxPositionArray = $positionArray;
<a name="line1759"></a>
<a name="line1760"></a>
<a name="line1761"></a>		$transaprencyAmount = $this->invertTransparency($transaprencyAmount, 127, false);
<a name="line1762"></a>		$transparent = imagecolorallocatealpha($this->imageResized, $r, $g, $b, $transaprencyAmount);
<a name="line1763"></a>		imagefilledrectangle($this->imageResized, $positionArray['x1'], $positionArray['y1'], $positionArray['x2'], $positionArray['y2'], $transparent);
<a name="line1764"></a>	}
<a name="line1765"></a>
<a name="line1766"></a>	## --------------------------------------------------------
<a name="line1767"></a>
<a name="line1768"></a>	public function addTextToCaptionBox($text, $fontColor = '#fff', $fontSize = 12, $angle = 0, $font = null)
<a name="line1769"></a>		#
<a name="line1770"></a>		# Author:   Jarrod Oberto
<a name="line1771"></a>		# Date:   03 Aug 11
<a name="line1772"></a>		# Purpose:  Simplify adding text to a caption box by automatically
<a name="line1773"></a>		#       locating the center of the caption box
<a name="line1774"></a>		# Params in:  The usually text paams (less a couple)
<a name="line1775"></a>		# Params out: n/a
<a name="line1776"></a>		# Notes:
<a name="line1777"></a>		#
<a name="line1778"></a>	{
<a name="line1779"></a>
<a name="line1780"></a>		// *** Get the caption box measurements
<a name="line1781"></a>		if (count($this->captionBoxPositionArray) == 4)
<a name="line1782"></a>		{
<a name="line1783"></a>			$x1 = $this->captionBoxPositionArray['x1'];
<a name="line1784"></a>			$x2 = $this->captionBoxPositionArray['x2'];
<a name="line1785"></a>			$y1 = $this->captionBoxPositionArray['y1'];
<a name="line1786"></a>			$y2 = $this->captionBoxPositionArray['y2'];
<a name="line1787"></a>		}
<a name="line1788"></a>		else
<a name="line1789"></a>		{
<a name="line1790"></a>			if ($this->debug)
<a name="line1791"></a>			{
<a name="line1792"></a>				throw new Exception('No caption box found.');
<a name="line1793"></a>			}
<a name="line1794"></a>			else
<a name="line1795"></a>			{
<a name="line1796"></a>				return false;
<a name="line1797"></a>			}
<a name="line1798"></a>		}
<a name="line1799"></a>
<a name="line1800"></a>
<a name="line1801"></a>		// *** Get text font
<a name="line1802"></a>		$font = $this->getTextFont($font);
<a name="line1803"></a>
<a name="line1804"></a>		// *** Get text size
<a name="line1805"></a>		$textSizeArray = $this->getTextSize($fontSize, $angle, $font, $text);
<a name="line1806"></a>		$textWidth = $textSizeArray['width'];
<a name="line1807"></a>		$textHeight = $textSizeArray['height'];
<a name="line1808"></a>
<a name="line1809"></a>		// *** Find the width/height middle points
<a name="line1810"></a>		$boxXMiddle = (($x2 - $x1) / 2);
<a name="line1811"></a>		$boxYMiddle = (($y2 - $y1) / 2);
<a name="line1812"></a>
<a name="line1813"></a>		// *** Box middle - half the text width/height
<a name="line1814"></a>		$xPos = ($x1 + $boxXMiddle) - ($textWidth / 2);
<a name="line1815"></a>		$yPos = ($y1 + $boxYMiddle) - ($textHeight / 2);
<a name="line1816"></a>
<a name="line1817"></a>		$pos = $xPos . 'x' . $yPos;
<a name="line1818"></a>
<a name="line1819"></a>		$this->addText($text, $pos, $padding = 0, $fontColor, $fontSize, $angle, $font);
<a name="line1820"></a>
<a name="line1821"></a>	}
<a name="line1822"></a>
<a name="line1823"></a>	## --------------------------------------------------------
<a name="line1824"></a>
<a name="line1825"></a>	private function calculateCaptionBoxPosition($side, $thickness, $padding)
<a name="line1826"></a>	{
<a name="line1827"></a>		$positionArray = array();
<a name="line1828"></a>
<a name="line1829"></a>		switch ($side)
<a name="line1830"></a>		{
<a name="line1831"></a>			case 't':
<a name="line1832"></a>				$positionArray['x1'] = 0;
<a name="line1833"></a>				$positionArray['y1'] = $padding;
<a name="line1834"></a>				$positionArray['x2'] = $this->width;
<a name="line1835"></a>				$positionArray['y2'] = $thickness + $padding;
<a name="line1836"></a>				break;
<a name="line1837"></a>			case 'r':
<a name="line1838"></a>				$positionArray['x1'] = $this->width - $thickness - $padding;
<a name="line1839"></a>				$positionArray['y1'] = 0;
<a name="line1840"></a>				$positionArray['x2'] = $this->width - $padding;
<a name="line1841"></a>				$positionArray['y2'] = $this->height;
<a name="line1842"></a>				break;
<a name="line1843"></a>			case 'b':
<a name="line1844"></a>				$positionArray['x1'] = 0;
<a name="line1845"></a>				$positionArray['y1'] = $this->height - $thickness - $padding;
<a name="line1846"></a>				$positionArray['x2'] = $this->width;
<a name="line1847"></a>				$positionArray['y2'] = $this->height - $padding;
<a name="line1848"></a>				break;
<a name="line1849"></a>			case 'l':
<a name="line1850"></a>				$positionArray['x1'] = $padding;
<a name="line1851"></a>				$positionArray['y1'] = 0;
<a name="line1852"></a>				$positionArray['x2'] = $thickness + $padding;
<a name="line1853"></a>				$positionArray['y2'] = $this->height;
<a name="line1854"></a>				break;
<a name="line1855"></a>
<a name="line1856"></a>			default:
<a name="line1857"></a>				break;
<a name="line1858"></a>		}
<a name="line1859"></a>
<a name="line1860"></a>		return $positionArray;
<a name="line1861"></a>
<a name="line1862"></a>	}
<a name="line1863"></a>
<a name="line1864"></a>	/*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*-
<a name="line1865"></a>  Get EXIF Data
<a name="line1866"></a>*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*/
<a name="line1867"></a>
<a name="line1868"></a>	public function getExif($debug = false)
<a name="line1869"></a>		# Author:     Jarrod Oberto
<a name="line1870"></a>		# Date:       07-05-2011
<a name="line1871"></a>		# Purpose:    Get image EXIF data
<a name="line1872"></a>		# Param in:   n/a
<a name="line1873"></a>		# Param out:  An associate array of EXIF data
<a name="line1874"></a>		# Reference:
<a name="line1875"></a>		# Notes:
<a name="line1876"></a>		# 23 May 13 : added orientation flag -jco
<a name="line1877"></a>		#
<a name="line1878"></a>	{
<a name="line1879"></a>
<a name="line1880"></a>		if ( ! $this->debug || ! $debug)
<a name="line1881"></a>		{
<a name="line1882"></a>			$debug = false;
<a name="line1883"></a>		}
<a name="line1884"></a>
<a name="line1885"></a>		// *** Check all is good - check the EXIF library exists and the file exists, too.
<a name="line1886"></a>		if ( ! $this->testEXIFInstalled())
<a name="line1887"></a>		{
<a name="line1888"></a>			if ($debug)
<a name="line1889"></a>			{
<a name="line1890"></a>				throw new Exception('The EXIF Library is not installed.');
<a name="line1891"></a>			}
<a name="line1892"></a>			else
<a name="line1893"></a>			{
<a name="line1894"></a>				return array();
<a name="line1895"></a>			}
<a name="line1896"></a>		};
<a name="line1897"></a>		if ( ! file_exists($this->fileName))
<a name="line1898"></a>		{
<a name="line1899"></a>			if ($debug)
<a name="line1900"></a>			{
<a name="line1901"></a>				throw new Exception('Image not found.');
<a name="line1902"></a>			}
<a name="line1903"></a>			else
<a name="line1904"></a>			{
<a name="line1905"></a>				return array();
<a name="line1906"></a>			}
<a name="line1907"></a>		};
<a name="line1908"></a>		if ($this->fileExtension != '.jpg')
<a name="line1909"></a>		{
<a name="line1910"></a>			if ($debug)
<a name="line1911"></a>			{
<a name="line1912"></a>				throw new Exception('Metadata not supported for this image type.');
<a name="line1913"></a>			}
<a name="line1914"></a>			else
<a name="line1915"></a>			{
<a name="line1916"></a>				return array();
<a name="line1917"></a>			}
<a name="line1918"></a>		};
<a name="line1919"></a>		$exifData = exif_read_data($this->fileName, 'IFD0');
<a name="line1920"></a>
<a name="line1921"></a>		// *** Format the apperture value
<a name="line1922"></a>		$ev = $exifData['ApertureValue'];
<a name="line1923"></a>		$apPeicesArray = explode('/', $ev);
<a name="line1924"></a>		if (count($apPeicesArray) == 2)
<a name="line1925"></a>		{
<a name="line1926"></a>			$apertureValue = round($apPeicesArray[0] / $apPeicesArray[1], 2, PHP_ROUND_HALF_DOWN) . ' EV';
<a name="line1927"></a>		}
<a name="line1928"></a>		else
<a name="line1929"></a>		{
<a name="line1930"></a>			$apertureValue = '';
<a name="line1931"></a>		}
<a name="line1932"></a>
<a name="line1933"></a>		// *** Format the focal length
<a name="line1934"></a>		$focalLength = $exifData['FocalLength'];
<a name="line1935"></a>		$flPeicesArray = explode('/', $focalLength);
<a name="line1936"></a>		if (count($flPeicesArray) == 2)
<a name="line1937"></a>		{
<a name="line1938"></a>			$focalLength = $flPeicesArray[0] / $flPeicesArray[1] . '.0 mm';
<a name="line1939"></a>		}
<a name="line1940"></a>		else
<a name="line1941"></a>		{
<a name="line1942"></a>			$focalLength = '';
<a name="line1943"></a>		}
<a name="line1944"></a>
<a name="line1945"></a>		// *** Format fNumber
<a name="line1946"></a>		$fNumber = $exifData['FNumber'];
<a name="line1947"></a>		$fnPeicesArray = explode('/', $fNumber);
<a name="line1948"></a>		if (count($fnPeicesArray) == 2)
<a name="line1949"></a>		{
<a name="line1950"></a>			$fNumber = $fnPeicesArray[0] / $fnPeicesArray[1];
<a name="line1951"></a>		}
<a name="line1952"></a>		else
<a name="line1953"></a>		{
<a name="line1954"></a>			$fNumber = '';
<a name="line1955"></a>		}
<a name="line1956"></a>
<a name="line1957"></a>		// *** Resolve ExposureProgram
<a name="line1958"></a>		if (isset($exifData['ExposureProgram']))
<a name="line1959"></a>		{
<a name="line1960"></a>			$ep = $exifData['ExposureProgram'];
<a name="line1961"></a>		}
<a name="line1962"></a>		if (isset($ep))
<a name="line1963"></a>		{
<a name="line1964"></a>			$ep = $this->resolveExposureProgram($ep);
<a name="line1965"></a>		}
<a name="line1966"></a>
<a name="line1967"></a>
<a name="line1968"></a>		// *** Resolve MeteringMode
<a name="line1969"></a>		$mm = $exifData['MeteringMode'];
<a name="line1970"></a>		$mm = $this->resolveMeteringMode($mm);
<a name="line1971"></a>
<a name="line1972"></a>		// *** Resolve Flash
<a name="line1973"></a>		$flash = $exifData['Flash'];
<a name="line1974"></a>		$flash = $this->resolveFlash($flash);
<a name="line1975"></a>
<a name="line1976"></a>
<a name="line1977"></a>		if (isset($exifData['Make']))
<a name="line1978"></a>		{
<a name="line1979"></a>			$exifDataArray['make'] = $exifData['Make'];
<a name="line1980"></a>		}
<a name="line1981"></a>		else
<a name="line1982"></a>		{
<a name="line1983"></a>			$exifDataArray['make'] = '';
<a name="line1984"></a>		}
<a name="line1985"></a>
<a name="line1986"></a>		if (isset($exifData['Model']))
<a name="line1987"></a>		{
<a name="line1988"></a>			$exifDataArray['model'] = $exifData['Model'];
<a name="line1989"></a>		}
<a name="line1990"></a>		else
<a name="line1991"></a>		{
<a name="line1992"></a>			$exifDataArray['model'] = '';
<a name="line1993"></a>		}
<a name="line1994"></a>
<a name="line1995"></a>		if (isset($exifData['DateTime']))
<a name="line1996"></a>		{
<a name="line1997"></a>			$exifDataArray['date'] = $exifData['DateTime'];
<a name="line1998"></a>		}
<a name="line1999"></a>		else
<a name="line2000"></a>		{
<a name="line2001"></a>			$exifDataArray['date'] = '';
<a name="line2002"></a>		}
<a name="line2003"></a>
<a name="line2004"></a>		if (isset($exifData['ExposureTime']))
<a name="line2005"></a>		{
<a name="line2006"></a>			$exifDataArray['exposure time'] = $exifData['ExposureTime'] . ' sec.';
<a name="line2007"></a>		}
<a name="line2008"></a>		else
<a name="line2009"></a>		{
<a name="line2010"></a>			$exifDataArray['exposure time'] = '';
<a name="line2011"></a>		}
<a name="line2012"></a>
<a name="line2013"></a>		if ($apertureValue != '')
<a name="line2014"></a>		{
<a name="line2015"></a>			$exifDataArray['aperture value'] = $apertureValue;
<a name="line2016"></a>		}
<a name="line2017"></a>		else
<a name="line2018"></a>		{
<a name="line2019"></a>			$exifDataArray['aperture value'] = '';
<a name="line2020"></a>		}
<a name="line2021"></a>
<a name="line2022"></a>		if (isset($exifData['COMPUTED']['ApertureFNumber']))
<a name="line2023"></a>		{
<a name="line2024"></a>			$exifDataArray['f-stop'] = $exifData['COMPUTED']['ApertureFNumber'];
<a name="line2025"></a>		}
<a name="line2026"></a>		else
<a name="line2027"></a>		{
<a name="line2028"></a>			$exifDataArray['f-stop'] = '';
<a name="line2029"></a>		}
<a name="line2030"></a>
<a name="line2031"></a>		if (isset($exifData['FNumber']))
<a name="line2032"></a>		{
<a name="line2033"></a>			$exifDataArray['fnumber'] = $exifData['FNumber'];
<a name="line2034"></a>		}
<a name="line2035"></a>		else
<a name="line2036"></a>		{
<a name="line2037"></a>			$exifDataArray['fnumber'] = '';
<a name="line2038"></a>		}
<a name="line2039"></a>
<a name="line2040"></a>		if ($fNumber != '')
<a name="line2041"></a>		{
<a name="line2042"></a>			$exifDataArray['fnumber value'] = $fNumber;
<a name="line2043"></a>		}
<a name="line2044"></a>		else
<a name="line2045"></a>		{
<a name="line2046"></a>			$exifDataArray['fnumber value'] = '';
<a name="line2047"></a>		}
<a name="line2048"></a>
<a name="line2049"></a>		if (isset($exifData['ISOSpeedRatings']))
<a name="line2050"></a>		{
<a name="line2051"></a>			$exifDataArray['iso'] = $exifData['ISOSpeedRatings'];
<a name="line2052"></a>		}
<a name="line2053"></a>		else
<a name="line2054"></a>		{
<a name="line2055"></a>			$exifDataArray['iso'] = '';
<a name="line2056"></a>		}
<a name="line2057"></a>
<a name="line2058"></a>		if ($focalLength != '')
<a name="line2059"></a>		{
<a name="line2060"></a>			$exifDataArray['focal length'] = $focalLength;
<a name="line2061"></a>		}
<a name="line2062"></a>		else
<a name="line2063"></a>		{
<a name="line2064"></a>			$exifDataArray['focal length'] = '';
<a name="line2065"></a>		}
<a name="line2066"></a>
<a name="line2067"></a>		if (isset($ep))
<a name="line2068"></a>		{
<a name="line2069"></a>			$exifDataArray['exposure program'] = $ep;
<a name="line2070"></a>		}
<a name="line2071"></a>		else
<a name="line2072"></a>		{
<a name="line2073"></a>			$exifDataArray['exposure program'] = '';
<a name="line2074"></a>		}
<a name="line2075"></a>
<a name="line2076"></a>		if ($mm != '')
<a name="line2077"></a>		{
<a name="line2078"></a>			$exifDataArray['metering mode'] = $mm;
<a name="line2079"></a>		}
<a name="line2080"></a>		else
<a name="line2081"></a>		{
<a name="line2082"></a>			$exifDataArray['metering mode'] = '';
<a name="line2083"></a>		}
<a name="line2084"></a>
<a name="line2085"></a>		if ($flash != '')
<a name="line2086"></a>		{
<a name="line2087"></a>			$exifDataArray['flash status'] = $flash;
<a name="line2088"></a>		}
<a name="line2089"></a>		else
<a name="line2090"></a>		{
<a name="line2091"></a>			$exifDataArray['flash status'] = '';
<a name="line2092"></a>		}
<a name="line2093"></a>
<a name="line2094"></a>		if (isset($exifData['Artist']))
<a name="line2095"></a>		{
<a name="line2096"></a>			$exifDataArray['creator'] = $exifData['Artist'];
<a name="line2097"></a>		}
<a name="line2098"></a>		else
<a name="line2099"></a>		{
<a name="line2100"></a>			$exifDataArray['creator'] = '';
<a name="line2101"></a>		}
<a name="line2102"></a>
<a name="line2103"></a>		if (isset($exifData['Copyright']))
<a name="line2104"></a>		{
<a name="line2105"></a>			$exifDataArray['copyright'] = $exifData['Copyright'];
<a name="line2106"></a>		}
<a name="line2107"></a>		else
<a name="line2108"></a>		{
<a name="line2109"></a>			$exifDataArray['copyright'] = '';
<a name="line2110"></a>		}
<a name="line2111"></a>
<a name="line2112"></a>		// *** Orientation
<a name="line2113"></a>		if (isset($exifData['Orientation']))
<a name="line2114"></a>		{
<a name="line2115"></a>			$exifDataArray['orientation'] = $exifData['Orientation'];
<a name="line2116"></a>		}
<a name="line2117"></a>		else
<a name="line2118"></a>		{
<a name="line2119"></a>			$exifDataArray['orientation'] = '';
<a name="line2120"></a>		}
<a name="line2121"></a>
<a name="line2122"></a>		return $exifDataArray;
<a name="line2123"></a>	}
<a name="line2124"></a>
<a name="line2125"></a>	## --------------------------------------------------------
<a name="line2126"></a>
<a name="line2127"></a>	private function resolveExposureProgram($ep)
<a name="line2128"></a>	{
<a name="line2129"></a>		switch ($ep)
<a name="line2130"></a>		{
<a name="line2131"></a>			case 0:
<a name="line2132"></a>				$ep = '';
<a name="line2133"></a>				break;
<a name="line2134"></a>			case 1:
<a name="line2135"></a>				$ep = 'manual';
<a name="line2136"></a>				break;
<a name="line2137"></a>			case 2:
<a name="line2138"></a>				$ep = 'normal program';
<a name="line2139"></a>				break;
<a name="line2140"></a>			case 3:
<a name="line2141"></a>				$ep = 'aperture priority';
<a name="line2142"></a>				break;
<a name="line2143"></a>			case 4:
<a name="line2144"></a>				$ep = 'shutter priority';
<a name="line2145"></a>				break;
<a name="line2146"></a>			case 5:
<a name="line2147"></a>				$ep = 'creative program';
<a name="line2148"></a>				break;
<a name="line2149"></a>			case 6:
<a name="line2150"></a>				$ep = 'action program';
<a name="line2151"></a>				break;
<a name="line2152"></a>			case 7:
<a name="line2153"></a>				$ep = 'portrait mode';
<a name="line2154"></a>				break;
<a name="line2155"></a>			case 8:
<a name="line2156"></a>				$ep = 'landscape mode';
<a name="line2157"></a>				break;
<a name="line2158"></a>
<a name="line2159"></a>			default:
<a name="line2160"></a>				break;
<a name="line2161"></a>		}
<a name="line2162"></a>
<a name="line2163"></a>		return $ep;
<a name="line2164"></a>	}
<a name="line2165"></a>
<a name="line2166"></a>	## --------------------------------------------------------
<a name="line2167"></a>
<a name="line2168"></a>	private function resolveMeteringMode($mm)
<a name="line2169"></a>	{
<a name="line2170"></a>		switch ($mm)
<a name="line2171"></a>		{
<a name="line2172"></a>			case 0:
<a name="line2173"></a>				$mm = 'unknown';
<a name="line2174"></a>				break;
<a name="line2175"></a>			case 1:
<a name="line2176"></a>				$mm = 'average';
<a name="line2177"></a>				break;
<a name="line2178"></a>			case 2:
<a name="line2179"></a>				$mm = 'center weighted average';
<a name="line2180"></a>				break;
<a name="line2181"></a>			case 3:
<a name="line2182"></a>				$mm = 'spot';
<a name="line2183"></a>				break;
<a name="line2184"></a>			case 4:
<a name="line2185"></a>				$mm = 'multi spot';
<a name="line2186"></a>				break;
<a name="line2187"></a>			case 5:
<a name="line2188"></a>				$mm = 'pattern';
<a name="line2189"></a>				break;
<a name="line2190"></a>			case 6:
<a name="line2191"></a>				$mm = 'partial';
<a name="line2192"></a>				break;
<a name="line2193"></a>			case 255:
<a name="line2194"></a>				$mm = 'other';
<a name="line2195"></a>				break;
<a name="line2196"></a>
<a name="line2197"></a>			default:
<a name="line2198"></a>				break;
<a name="line2199"></a>		}
<a name="line2200"></a>
<a name="line2201"></a>		return $mm;
<a name="line2202"></a>	}
<a name="line2203"></a>
<a name="line2204"></a>	## --------------------------------------------------------
<a name="line2205"></a>
<a name="line2206"></a>	private function resolveFlash($flash)
<a name="line2207"></a>	{
<a name="line2208"></a>		switch ($flash)
<a name="line2209"></a>		{
<a name="line2210"></a>			case 0:
<a name="line2211"></a>				$flash = 'flash did not fire';
<a name="line2212"></a>				break;
<a name="line2213"></a>			case 1:
<a name="line2214"></a>				$flash = 'flash fired';
<a name="line2215"></a>				break;
<a name="line2216"></a>			case 5:
<a name="line2217"></a>				$flash = 'strobe return light not detected';
<a name="line2218"></a>				break;
<a name="line2219"></a>			case 7:
<a name="line2220"></a>				$flash = 'strobe return light detected';
<a name="line2221"></a>				break;
<a name="line2222"></a>			case 9:
<a name="line2223"></a>				$flash = 'flash fired, compulsory flash mode';
<a name="line2224"></a>				break;
<a name="line2225"></a>			case 13:
<a name="line2226"></a>				$flash = 'flash fired, compulsory flash mode, return light not detected';
<a name="line2227"></a>				break;
<a name="line2228"></a>			case 15:
<a name="line2229"></a>				$flash = 'flash fired, compulsory flash mode, return light detected';
<a name="line2230"></a>				break;
<a name="line2231"></a>			case 16:
<a name="line2232"></a>				$flash = 'flash did not fire, compulsory flash mode';
<a name="line2233"></a>				break;
<a name="line2234"></a>			case 24:
<a name="line2235"></a>				$flash = 'flash did not fire, auto mode';
<a name="line2236"></a>				break;
<a name="line2237"></a>			case 25:
<a name="line2238"></a>				$flash = 'flash fired, auto mode';
<a name="line2239"></a>				break;
<a name="line2240"></a>			case 29:
<a name="line2241"></a>				$flash = 'flash fired, auto mode, return light not detected';
<a name="line2242"></a>				break;
<a name="line2243"></a>			case 31:
<a name="line2244"></a>				$flash = 'flash fired, auto mode, return light detected';
<a name="line2245"></a>				break;
<a name="line2246"></a>			case 32:
<a name="line2247"></a>				$flash = 'no flash function';
<a name="line2248"></a>				break;
<a name="line2249"></a>			case 65:
<a name="line2250"></a>				$flash = 'flash fired, red-eye reduction mode';
<a name="line2251"></a>				break;
<a name="line2252"></a>			case 69:
<a name="line2253"></a>				$flash = 'flash fired, red-eye reduction mode, return light not detected';
<a name="line2254"></a>				break;
<a name="line2255"></a>			case 71:
<a name="line2256"></a>				$flash = 'flash fired, red-eye reduction mode, return light detected';
<a name="line2257"></a>				break;
<a name="line2258"></a>			case 73:
<a name="line2259"></a>				$flash = 'flash fired, compulsory flash mode, red-eye reduction mode';
<a name="line2260"></a>				break;
<a name="line2261"></a>			case 77:
<a name="line2262"></a>				$flash = 'flash fired, compulsory flash mode, red-eye reduction mode, return light not detected';
<a name="line2263"></a>				break;
<a name="line2264"></a>			case 79:
<a name="line2265"></a>				$flash = 'flash fired, compulsory flash mode, red-eye reduction mode, return light detected';
<a name="line2266"></a>				break;
<a name="line2267"></a>			case 89:
<a name="line2268"></a>				$flash = 'flash fired, auto mode, red-eye reduction mode';
<a name="line2269"></a>				break;
<a name="line2270"></a>			case 93:
<a name="line2271"></a>				$flash = 'flash fired, auto mode, return light not detected, red-eye reduction mode';
<a name="line2272"></a>				break;
<a name="line2273"></a>			case 95:
<a name="line2274"></a>				$flash = 'flash fired, auto mode, return light detected, red-eye reduction mode';
<a name="line2275"></a>				break;
<a name="line2276"></a>
<a name="line2277"></a>			default:
<a name="line2278"></a>				break;
<a name="line2279"></a>		}
<a name="line2280"></a>
<a name="line2281"></a>		return $flash;
<a name="line2282"></a>
<a name="line2283"></a>	}
<a name="line2284"></a>
<a name="line2285"></a>
<a name="line2286"></a>	/*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*-
<a name="line2287"></a>  Get IPTC Data
<a name="line2288"></a>*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*/
<a name="line2289"></a>
<a name="line2290"></a>
<a name="line2291"></a>	/*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*-
<a name="line2292"></a>  Write IPTC Data
<a name="line2293"></a>*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*/
<a name="line2294"></a>
<a name="line2295"></a>	public function writeIPTCcaption($value)
<a name="line2296"></a>		# Caption
<a name="line2297"></a>	{
<a name="line2298"></a>		$this->writeIPTC(120, $value);
<a name="line2299"></a>	}
<a name="line2300"></a>
<a name="line2301"></a>	## --------------------------------------------------------
<a name="line2302"></a>
<a name="line2303"></a>	public function writeIPTCwriter($value)
<a name="line2304"></a>	{
<a name="line2305"></a>		//$this->writeIPTC(65, $value);
<a name="line2306"></a>	}
<a name="line2307"></a>
<a name="line2308"></a>	## --------------------------------------------------------
<a name="line2309"></a>
<a name="line2310"></a>	private function writeIPTC($dat, $value)
<a name="line2311"></a>	{
<a name="line2312"></a>
<a name="line2313"></a>		# LIMIT TO JPG
<a name="line2314"></a>
<a name="line2315"></a>		$caption_block = $this->iptc_maketag(2, $dat, $value);
<a name="line2316"></a>		$image_string = iptcembed($caption_block, $this->fileName);
<a name="line2317"></a>		file_put_contents('iptc.jpg', $image_string);
<a name="line2318"></a>	}
<a name="line2319"></a>
<a name="line2320"></a>## --------------------------------------------------------
<a name="line2321"></a>
<a name="line2322"></a>	private function iptc_maketag($rec, $dat, $val)
<a name="line2323"></a>		# Author:   Thies C. Arntzen
<a name="line2324"></a>		# Purpose:    Function to format the new IPTC text
<a name="line2325"></a>		# Param in:   $rec: Application record. (Were working with #2)
<a name="line2326"></a>		#       $dat: Index. (120 for caption, 118 for contact. See the IPTC IIM
<a name="line2327"></a>		#         specification:
<a name="line2328"></a>		#         http://www.iptc.org/std/IIM/4.1/specification/IIMV4.1.pdf
<a name="line2329"></a>		#       $val: Value/data/text. Make sure this is within the length
<a name="line2330"></a>		#         constraints of the IPTC IIM specification
<a name="line2331"></a>		# Ref:      http://blog.peterhaza.no/working-with-image-meta-data-in-exif-and-iptc-headers-from-php/
<a name="line2332"></a>		#       http://php.net/manual/en/function.iptcembed.php
<a name="line2333"></a>		#
<a name="line2334"></a>	{
<a name="line2335"></a>		$len = strlen($val);
<a name="line2336"></a>		if ($len < 0x8000)
<a name="line2337"></a>		{
<a name="line2338"></a>			return chr(0x1c) . chr($rec) . chr($dat) .
<a name="line2339"></a>			chr($len >> 8) .
<a name="line2340"></a>			chr($len & 0xff) .
<a name="line2341"></a>			$val;
<a name="line2342"></a>		}
<a name="line2343"></a>		else
<a name="line2344"></a>		{
<a name="line2345"></a>			return chr(0x1c) . chr($rec) . chr($dat) .
<a name="line2346"></a>			chr(0x80) . chr(0x04) .
<a name="line2347"></a>			chr(($len >> 24) & 0xff) .
<a name="line2348"></a>			chr(($len >> 16) & 0xff) .
<a name="line2349"></a>			chr(($len >> 8) & 0xff) .
<a name="line2350"></a>			chr(($len) & 0xff) .
<a name="line2351"></a>			$val;
<a name="line2352"></a>		}
<a name="line2353"></a>	}
<a name="line2354"></a>
<a name="line2355"></a>
<a name="line2356"></a>
<a name="line2357"></a>	/*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*-
<a name="line2358"></a>  Write XMP Data
<a name="line2359"></a>*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*/
<a name="line2360"></a>
<a name="line2361"></a>	//http://xmpphptoolkit.sourceforge.net/
<a name="line2362"></a>
<a name="line2363"></a>
<a name="line2364"></a>	/*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*-
<a name="line2365"></a>  Add Text
<a name="line2366"></a>*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*/
<a name="line2367"></a>
<a name="line2368"></a>	public function addText($text, $pos = '20x20', $padding = 0, $fontColor = '#fff', $fontSize = 12, $angle = 0, $font = null)
<a name="line2369"></a>		# Author:     Jarrod Oberto
<a name="line2370"></a>		# Date:       18-11-09
<a name="line2371"></a>		# Purpose:    Add text to an image
<a name="line2372"></a>		# Param in:
<a name="line2373"></a>		# Param out:
<a name="line2374"></a>		# Reference:  http://php.net/manual/en/function.imagettftext.php
<a name="line2375"></a>		# Notes:      Make sure you supply the font.
<a name="line2376"></a>		#
<a name="line2377"></a>	{
<a name="line2378"></a>
<a name="line2379"></a>		// *** Convert color
<a name="line2380"></a>		$rgbArray = $this->formatColor($fontColor);
<a name="line2381"></a>		$r = $rgbArray['r'];
<a name="line2382"></a>		$g = $rgbArray['g'];
<a name="line2383"></a>		$b = $rgbArray['b'];
<a name="line2384"></a>
<a name="line2385"></a>		// *** Get text font
<a name="line2386"></a>		$font = $this->getTextFont($font);
<a name="line2387"></a>
<a name="line2388"></a>		// *** Get text size
<a name="line2389"></a>		$textSizeArray = $this->getTextSize($fontSize, $angle, $font, $text);
<a name="line2390"></a>		$textWidth = $textSizeArray['width'];
<a name="line2391"></a>		$textHeight = $textSizeArray['height'];
<a name="line2392"></a>
<a name="line2393"></a>		// *** Find co-ords to place text
<a name="line2394"></a>		$posArray = $this->calculatePosition($pos, $padding, $textWidth, $textHeight, false);
<a name="line2395"></a>		$x = $posArray['width'];
<a name="line2396"></a>		$y = $posArray['height'];
<a name="line2397"></a>
<a name="line2398"></a>		$fontColor = imagecolorallocate($this->imageResized, $r, $g, $b);
<a name="line2399"></a>
<a name="line2400"></a>		// *** Add text
<a name="line2401"></a>		imagettftext($this->imageResized, $fontSize, $angle, $x, $y, $fontColor, $font, $text);
<a name="line2402"></a>	}
<a name="line2403"></a>
<a name="line2404"></a>	## --------------------------------------------------------
<a name="line2405"></a>
<a name="line2406"></a>	private function getTextFont($font)
<a name="line2407"></a>	{
<a name="line2408"></a>		// *** Font path (shou
<a name="line2409"></a>		$fontPath = dirname(__FILE__) . '/' . $this->fontDir;
<a name="line2410"></a>
<a name="line2411"></a>
<a name="line2412"></a>		// *** The below is/may be needed depending on your version (see ref)
<a name="line2413"></a>		putenv('GDFONTPATH=' . realpath('.'));
<a name="line2414"></a>
<a name="line2415"></a>		// *** Check if the passed in font exsits...
<a name="line2416"></a>		if ($font == null || ! file_exists($font))
<a name="line2417"></a>		{
<a name="line2418"></a>
<a name="line2419"></a>			// *** ...If not, default to this font.
<a name="line2420"></a>			$font = $fontPath . '/arimo.ttf';
<a name="line2421"></a>
<a name="line2422"></a>			// *** Check our default font exists...
<a name="line2423"></a>			if ( ! file_exists($font))
<a name="line2424"></a>			{
<a name="line2425"></a>
<a name="line2426"></a>				// *** If not, return false
<a name="line2427"></a>				if ($this->debug)
<a name="line2428"></a>				{
<a name="line2429"></a>					throw new Exception('Font not found');
<a name="line2430"></a>				}
<a name="line2431"></a>				else
<a name="line2432"></a>				{
<a name="line2433"></a>					return false;
<a name="line2434"></a>				}
<a name="line2435"></a>			}
<a name="line2436"></a>		}
<a name="line2437"></a>
<a name="line2438"></a>		return $font;
<a name="line2439"></a>
<a name="line2440"></a>	}
<a name="line2441"></a>
<a name="line2442"></a>	## --------------------------------------------------------
<a name="line2443"></a>
<a name="line2444"></a>	private function getTextSize($fontSize, $angle, $font, $text)
<a name="line2445"></a>	{
<a name="line2446"></a>
<a name="line2447"></a>		// *** Define box (so we can get the width)
<a name="line2448"></a>		$box = @imageTTFBbox($fontSize, $angle, $font, $text);
<a name="line2449"></a>
<a name="line2450"></a>		// ***  Get width of text from dimensions
<a name="line2451"></a>		$textWidth = abs($box[4] - $box[0]);
<a name="line2452"></a>
<a name="line2453"></a>		// ***  Get height of text from dimensions (should also be same as $fontSize)
<a name="line2454"></a>		$textHeight = abs($box[5] - $box[1]);
<a name="line2455"></a>
<a name="line2456"></a>		return array( 'height' => $textHeight, 'width' => $textWidth );
<a name="line2457"></a>	}
<a name="line2458"></a>
<a name="line2459"></a>
<a name="line2460"></a>	/*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*-
<a name="line2461"></a>  Add Watermark
<a name="line2462"></a>*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*/
<a name="line2463"></a>
<a name="line2464"></a>	public function addWatermark($watermarkImage, $pos, $padding = 0, $opacity = 0)
<a name="line2465"></a>		# Author:     Jarrod Oberto
<a name="line2466"></a>		# Date:       18-11-09
<a name="line2467"></a>		# Purpose:    Add watermark image
<a name="line2468"></a>		# Param in:   (str) $watermark: The watermark image
<a name="line2469"></a>		#       (str) $pos: Could be a pre-determined position such as:
<a name="line2470"></a>		#           tl = top left,
<a name="line2471"></a>		#           t  = top (middle),
<a name="line2472"></a>		#           tr = top right,
<a name="line2473"></a>		#           l  = left,
<a name="line2474"></a>		#           m  = middle,
<a name="line2475"></a>		#           r  = right,
<a name="line2476"></a>		#           bl = bottom left,
<a name="line2477"></a>		#           b  = bottom (middle),
<a name="line2478"></a>		#           br = bottom right
<a name="line2479"></a>		#         Or, it could be a co-ordinate position such as: 50x100
<a name="line2480"></a>		#
<a name="line2481"></a>		#       (int) $padding: If using a pre-determined position you can
<a name="line2482"></a>		#         adjust the padding from the edges by passing an amount
<a name="line2483"></a>		#         in pixels. If using co-ordinates, this value is ignored.
<a name="line2484"></a>		# Param out:
<a name="line2485"></a>		# Reference:  http://www.php.net/manual/en/image.examples-watermark.php
<a name="line2486"></a>		# Notes:      Based on example in reference.
<a name="line2487"></a>		#
<a name="line2488"></a>		#
<a name="line2489"></a>	{
<a name="line2490"></a>
<a name="line2491"></a>		// Load the stamp and the photo to apply the watermark to
<a name="line2492"></a>		$stamp = $this->openImage($watermarkImage);    # stamp
<a name="line2493"></a>		$im = $this->imageResized;            # photo
<a name="line2494"></a>
<a name="line2495"></a>		// *** Get stamps width and height
<a name="line2496"></a>		$sx = imagesx($stamp);
<a name="line2497"></a>		$sy = imagesy($stamp);
<a name="line2498"></a>
<a name="line2499"></a>		// *** Find co-ords to place image
<a name="line2500"></a>		$posArray = $this->calculatePosition($pos, $padding, $sx, $sy);
<a name="line2501"></a>		$x = $posArray['width'];
<a name="line2502"></a>		$y = $posArray['height'];
<a name="line2503"></a>
<a name="line2504"></a>		// *** Set watermark opacity
<a name="line2505"></a>		if (fix_strtolower(strrchr($watermarkImage, '.')) == '.png')
<a name="line2506"></a>		{
<a name="line2507"></a>
<a name="line2508"></a>			$opacity = $this->invertTransparency($opacity, 100);
<a name="line2509"></a>			$this->filterOpacity($stamp, $opacity);
<a name="line2510"></a>		}
<a name="line2511"></a>
<a name="line2512"></a>		// Copy the watermark image onto our photo
<a name="line2513"></a>		imagecopy($im, $stamp, $x, $y, 0, 0, imagesx($stamp), imagesy($stamp));
<a name="line2514"></a>
<a name="line2515"></a>	}
<a name="line2516"></a>
<a name="line2517"></a>	## --------------------------------------------------------
<a name="line2518"></a>
<a name="line2519"></a>	private function calculatePosition($pos, $padding, $assetWidth, $assetHeight, $upperLeft = true)
<a name="line2520"></a>		#
<a name="line2521"></a>		# Author:   Jarrod Oberto
<a name="line2522"></a>		# Date:   08-05-11
<a name="line2523"></a>		# Purpose:  Calculate the x, y pixel cordinates of the asset to place
<a name="line2524"></a>		# Params in:  (str) $pos: Either something like: "tl", "l", "br" or an
<a name="line2525"></a>		#         exact position like: "100x50"
<a name="line2526"></a>		#       (int) $padding: The amount of padding from the edge. Only
<a name="line2527"></a>		#         used for the predefined $pos.
<a name="line2528"></a>		#       (int) $assetWidth: The width of the asset to add to the image
<a name="line2529"></a>		#       (int) $assetHeight: The height of the asset to add to the image
<a name="line2530"></a>		#       (bol) $upperLeft: if true, the asset will be positioned based
<a name="line2531"></a>		#         on the upper left x, y coords. If false, it means you're
<a name="line2532"></a>		#         using the lower left as the basepoint and this will
<a name="line2533"></a>		#         convert it to the upper left position
<a name="line2534"></a>		# Params out:
<a name="line2535"></a>		# NOTE: this is done from the UPPER left corner!! But will convert lower
<a name="line2536"></a>		#   left basepoints to upper left if $upperleft is set to false
<a name="line2537"></a>		#
<a name="line2538"></a>		#
<a name="line2539"></a>	{
<a name="line2540"></a>		$pos = fix_strtolower($pos);
<a name="line2541"></a>
<a name="line2542"></a>		// *** If co-ords have been entered
<a name="line2543"></a>		if (strstr($pos, 'x'))
<a name="line2544"></a>		{
<a name="line2545"></a>			$pos = str_replace(' ', '', $pos);
<a name="line2546"></a>
<a name="line2547"></a>			$xyArray = explode('x', $pos);
<a name="line2548"></a>			list($width, $height) = $xyArray;
<a name="line2549"></a>
<a name="line2550"></a>		}
<a name="line2551"></a>		else
<a name="line2552"></a>		{
<a name="line2553"></a>
<a name="line2554"></a>			switch ($pos)
<a name="line2555"></a>			{
<a name="line2556"></a>				case 'tl':
<a name="line2557"></a>					$width = 0 + $padding;
<a name="line2558"></a>					$height = 0 + $padding;
<a name="line2559"></a>					break;
<a name="line2560"></a>
<a name="line2561"></a>				case 't':
<a name="line2562"></a>					$width = ($this->width / 2) - ($assetWidth / 2);
<a name="line2563"></a>					$height = 0 + $padding;
<a name="line2564"></a>					break;
<a name="line2565"></a>
<a name="line2566"></a>				case 'tr':
<a name="line2567"></a>					$width = $this->width - $assetWidth - $padding;
<a name="line2568"></a>					$height = 0 + $padding;;
<a name="line2569"></a>					break;
<a name="line2570"></a>
<a name="line2571"></a>				case 'l':
<a name="line2572"></a>					$width = 0 + $padding;
<a name="line2573"></a>					$height = ($this->height / 2) - ($assetHeight / 2);
<a name="line2574"></a>					break;
<a name="line2575"></a>
<a name="line2576"></a>				case 'm':
<a name="line2577"></a>					$width = ($this->width / 2) - ($assetWidth / 2);
<a name="line2578"></a>					$height = ($this->height / 2) - ($assetHeight / 2);
<a name="line2579"></a>					break;
<a name="line2580"></a>
<a name="line2581"></a>				case 'r':
<a name="line2582"></a>					$width = $this->width - $assetWidth - $padding;
<a name="line2583"></a>					$height = ($this->height / 2) - ($assetHeight / 2);
<a name="line2584"></a>					break;
<a name="line2585"></a>
<a name="line2586"></a>				case 'bl':
<a name="line2587"></a>					$width = 0 + $padding;
<a name="line2588"></a>					$height = $this->height - $assetHeight - $padding;
<a name="line2589"></a>					break;
<a name="line2590"></a>
<a name="line2591"></a>				case 'b':
<a name="line2592"></a>					$width = ($this->width / 2) - ($assetWidth / 2);
<a name="line2593"></a>					$height = $this->height - $assetHeight - $padding;
<a name="line2594"></a>					break;
<a name="line2595"></a>
<a name="line2596"></a>				case 'br':
<a name="line2597"></a>					$width = $this->width - $assetWidth - $padding;
<a name="line2598"></a>					$height = $this->height - $assetHeight - $padding;
<a name="line2599"></a>					break;
<a name="line2600"></a>
<a name="line2601"></a>				default:
<a name="line2602"></a>					$width = 0;
<a name="line2603"></a>					$height = 0;
<a name="line2604"></a>					break;
<a name="line2605"></a>			}
<a name="line2606"></a>		}
<a name="line2607"></a>
<a name="line2608"></a>		if ( ! $upperLeft)
<a name="line2609"></a>		{
<a name="line2610"></a>			$height = $height + $assetHeight;
<a name="line2611"></a>		}
<a name="line2612"></a>
<a name="line2613"></a>		return array( 'width' => $width, 'height' => $height );
<a name="line2614"></a>	}
<a name="line2615"></a>
<a name="line2616"></a>
<a name="line2617"></a>	## --------------------------------------------------------
<a name="line2618"></a>
<a name="line2619"></a>	private function filterOpacity(&$img, $opacity = 75)
<a name="line2620"></a>		#
<a name="line2621"></a>		# Author:     aiden dot mail at freemail dot hu
<a name="line2622"></a>		# Author date:  29-03-08 08:16
<a name="line2623"></a>		# Date added:   08-05-11
<a name="line2624"></a>		# Purpose:    Change opacity of image
<a name="line2625"></a>		# Params in:    $img: Image resource id
<a name="line2626"></a>		#         (int) $opacity: the opacity amount: 0-100, 100 being not opaque.
<a name="line2627"></a>		# Params out:   (bool) true on success, else false
<a name="line2628"></a>		# Ref:      http://www.php.net/manual/en/function.imagefilter.php#82162
<a name="line2629"></a>		# Notes:      png only
<a name="line2630"></a>		#
<a name="line2631"></a>	{
<a name="line2632"></a>
<a name="line2633"></a>		if ( ! isset($opacity))
<a name="line2634"></a>		{
<a name="line2635"></a>			return false;
<a name="line2636"></a>		}
<a name="line2637"></a>
<a name="line2638"></a>		if ($opacity == 100)
<a name="line2639"></a>		{
<a name="line2640"></a>			return true;
<a name="line2641"></a>		}
<a name="line2642"></a>
<a name="line2643"></a>		$opacity /= 100;
<a name="line2644"></a>
<a name="line2645"></a>		//get image width and height
<a name="line2646"></a>		$w = imagesx($img);
<a name="line2647"></a>		$h = imagesy($img);
<a name="line2648"></a>
<a name="line2649"></a>		//turn alpha blending off
<a name="line2650"></a>		imagealphablending($img, false);
<a name="line2651"></a>
<a name="line2652"></a>		//find the most opaque pixel in the image (the one with the smallest alpha value)
<a name="line2653"></a>		$minalpha = 127;
<a name="line2654"></a>		for ($x = 0; $x < $w; $x++)
<a name="line2655"></a>		{
<a name="line2656"></a>			for ($y = 0; $y < $h; $y++)
<a name="line2657"></a>			{
<a name="line2658"></a>				$alpha = (imagecolorat($img, $x, $y) >> 24) & 0xFF;
<a name="line2659"></a>				if ($alpha < $minalpha)
<a name="line2660"></a>				{
<a name="line2661"></a>					$minalpha = $alpha;
<a name="line2662"></a>				}
<a name="line2663"></a>			}
<a name="line2664"></a>		}
<a name="line2665"></a>
<a name="line2666"></a>		//loop through image pixels and modify alpha for each
<a name="line2667"></a>		for ($x = 0; $x < $w; $x++)
<a name="line2668"></a>		{
<a name="line2669"></a>			for ($y = 0; $y < $h; $y++)
<a name="line2670"></a>			{
<a name="line2671"></a>				//get current alpha value (represents the TANSPARENCY!)
<a name="line2672"></a>				$colorxy = imagecolorat($img, $x, $y);
<a name="line2673"></a>				$alpha = ($colorxy >> 24) & 0xFF;
<a name="line2674"></a>				//calculate new alpha
<a name="line2675"></a>				if ($minalpha !== 127)
<a name="line2676"></a>				{
<a name="line2677"></a>					$alpha = 127 + 127 * $opacity * ($alpha - 127) / (127 - $minalpha);
<a name="line2678"></a>				}
<a name="line2679"></a>				else
<a name="line2680"></a>				{
<a name="line2681"></a>					$alpha += 127 * $opacity;
<a name="line2682"></a>				}
<a name="line2683"></a>				//get the color index with new alpha
<a name="line2684"></a>				$alphacolorxy = imagecolorallocatealpha($img, ($colorxy >> 16) & 0xFF, ($colorxy >> 8) & 0xFF, $colorxy & 0xFF, $alpha);
<a name="line2685"></a>				//set pixel with the new color + opacity
<a name="line2686"></a>				if ( ! imagesetpixel($img, $x, $y, $alphacolorxy))
<a name="line2687"></a>				{
<a name="line2688"></a>
<a name="line2689"></a>					return false;
<a name="line2690"></a>				}
<a name="line2691"></a>			}
<a name="line2692"></a>		}
<a name="line2693"></a>
<a name="line2694"></a>		return true;
<a name="line2695"></a>	}
<a name="line2696"></a>
<a name="line2697"></a>## --------------------------------------------------------
<a name="line2698"></a>
<a name="line2699"></a>	private function openImage($file)
<a name="line2700"></a>		# Author:     Jarrod Oberto
<a name="line2701"></a>		# Date:       27-02-08
<a name="line2702"></a>		# Purpose:
<a name="line2703"></a>		# Param in:
<a name="line2704"></a>		# Param out:  n/a
<a name="line2705"></a>		# Reference:
<a name="line2706"></a>		# Notes:
<a name="line2707"></a>		#
<a name="line2708"></a>	{
<a name="line2709"></a>
<a name="line2710"></a>		if ( ! file_exists($file) && ! $this->checkStringStartsWith('http://', $file) && ! $this->checkStringStartsWith('https://', $file) )
<a name="line2711"></a>		{
<a name="line2712"></a>			if ($this->debug)
<a name="line2713"></a>			{
<a name="line2714"></a>				throw new Exception('Image not found.');
<a name="line2715"></a>			}
<a name="line2716"></a>			else
<a name="line2717"></a>			{
<a name="line2718"></a>				throw new Exception();
<a name="line2719"></a>			}
<a name="line2720"></a>		};
<a name="line2721"></a>
<a name="line2722"></a>		// *** Get extension
<a name="line2723"></a>		$extension = strrchr($file, '.');
<a name="line2724"></a>		$extension = fix_strtolower($extension);
<a name="line2725"></a>		switch ($extension)
<a name="line2726"></a>		{
<a name="line2727"></a>			case '.jpg':
<a name="line2728"></a>			case '.jpeg':
<a name="line2729"></a>				$img = @imagecreatefromjpeg($file);
<a name="line2730"></a>				break;
<a name="line2731"></a>			case '.gif':
<a name="line2732"></a>				$img = @imagecreatefromgif($file);
<a name="line2733"></a>				break;
<a name="line2734"></a>			case '.png':
<a name="line2735"></a>				$img = @imagecreatefrompng($file);
<a name="line2736"></a>				break;
<a name="line2737"></a>			case '.bmp':
<a name="line2738"></a>				$img = @$this->imagecreatefrombmp($file);
<a name="line2739"></a>				break;
<a name="line2740"></a>			case '.psd':
<a name="line2741"></a>				$img = @$this->imagecreatefrompsd($file);
<a name="line2742"></a>				break;
<a name="line2743"></a>
<a name="line2744"></a>
<a name="line2745"></a>			// ... etc
<a name="line2746"></a>
<a name="line2747"></a>			default:
<a name="line2748"></a>				$img = false;
<a name="line2749"></a>				break;
<a name="line2750"></a>		}
<a name="line2751"></a>
<a name="line2752"></a>		return $img;
<a name="line2753"></a>	}
<a name="line2754"></a>
<a name="line2755"></a>## --------------------------------------------------------
<a name="line2756"></a>
<a name="line2757"></a>	public function reset()
<a name="line2758"></a>		#
<a name="line2759"></a>		# Author:   Jarrod Oberto
<a name="line2760"></a>		# Date:   30-08-11
<a name="line2761"></a>		# Purpose:  Reset the resource (allow further editing)
<a name="line2762"></a>		# Params in:
<a name="line2763"></a>		# Params out:
<a name="line2764"></a>		# Notes:
<a name="line2765"></a>		#
<a name="line2766"></a>	{
<a name="line2767"></a>		$this->__construct($this->fileName);
<a name="line2768"></a>	}
<a name="line2769"></a>
<a name="line2770"></a>## --------------------------------------------------------
<a name="line2771"></a>
<a name="line2772"></a>	public function saveImage($savePath, $imageQuality = "100")
<a name="line2773"></a>		# Author:     Jarrod Oberto
<a name="line2774"></a>		# Date:       27-02-08
<a name="line2775"></a>		# Purpose:    Saves the image
<a name="line2776"></a>		# Param in:   $savePath: Where to save the image including filename:
<a name="line2777"></a>		#             $imageQuality: image quality you want the image saved at 0-100
<a name="line2778"></a>		# Param out:  n/a
<a name="line2779"></a>		# Reference:
<a name="line2780"></a>		# Notes:    * gif doesn't have a quality parameter
<a name="line2781"></a>		#       * jpg has a quality setting 0-100 (100 being the best)
<a name="line2782"></a>		#       * png has a quality setting 0-9 (0 being the best)
<a name="line2783"></a>		#
<a name="line2784"></a>		#             * bmp files have no native support for bmp files. We use a
<a name="line2785"></a>		#       third party class to save as bmp.
<a name="line2786"></a>	{
<a name="line2787"></a>
<a name="line2788"></a>		// *** Perform a check or two.
<a name="line2789"></a>		if ( ! is_resource($this->imageResized))
<a name="line2790"></a>		{
<a name="line2791"></a>			if ($this->debug)
<a name="line2792"></a>			{
<a name="line2793"></a>				throw new Exception('saveImage: This is not a resource.');
<a name="line2794"></a>			}
<a name="line2795"></a>			else
<a name="line2796"></a>			{
<a name="line2797"></a>				throw new Exception();
<a name="line2798"></a>			}
<a name="line2799"></a>		}
<a name="line2800"></a>		$fileInfoArray = pathInfo($savePath);
<a name="line2801"></a>		clearstatcache();
<a name="line2802"></a>		if ( ! is_writable($fileInfoArray['dirname']))
<a name="line2803"></a>		{
<a name="line2804"></a>			if ($this->debug)
<a name="line2805"></a>			{
<a name="line2806"></a>				throw new Exception('The path is not writable. Please check your permissions.');
<a name="line2807"></a>			}
<a name="line2808"></a>			else
<a name="line2809"></a>			{
<a name="line2810"></a>				throw new Exception();
<a name="line2811"></a>			}
<a name="line2812"></a>		}
<a name="line2813"></a>
<a name="line2814"></a>		// *** Get extension
<a name="line2815"></a>		$extension = strrchr($savePath, '.');
<a name="line2816"></a>		$extension = fix_strtolower($extension);
<a name="line2817"></a>
<a name="line2818"></a>		$error = '';
<a name="line2819"></a>
<a name="line2820"></a>		switch ($extension)
<a name="line2821"></a>		{
<a name="line2822"></a>			case '.jpg':
<a name="line2823"></a>			case '.jpeg':
<a name="line2824"></a>				$this->checkInterlaceImage($this->isInterlace);
<a name="line2825"></a>				if (imagetypes() & IMG_JPG)
<a name="line2826"></a>				{
<a name="line2827"></a>					imagejpeg($this->imageResized, $savePath, $imageQuality);
<a name="line2828"></a>				}
<a name="line2829"></a>				else
<a name="line2830"></a>				{
<a name="line2831"></a>					$error = 'jpg';
<a name="line2832"></a>				}
<a name="line2833"></a>				break;
<a name="line2834"></a>
<a name="line2835"></a>			case '.gif':
<a name="line2836"></a>				$this->checkInterlaceImage($this->isInterlace);
<a name="line2837"></a>				if (imagetypes() & IMG_GIF)
<a name="line2838"></a>				{
<a name="line2839"></a>					imagegif($this->imageResized, $savePath);
<a name="line2840"></a>				}
<a name="line2841"></a>				else
<a name="line2842"></a>				{
<a name="line2843"></a>					$error = 'gif';
<a name="line2844"></a>				}
<a name="line2845"></a>				break;
<a name="line2846"></a>
<a name="line2847"></a>			case '.png':
<a name="line2848"></a>				// *** Scale quality from 0-100 to 0-9
<a name="line2849"></a>				$scaleQuality = round(($imageQuality / 100) * 9);
<a name="line2850"></a>
<a name="line2851"></a>				// *** Invert qualit setting as 0 is best, not 9
<a name="line2852"></a>				$invertScaleQuality = 9 - $scaleQuality;
<a name="line2853"></a>
<a name="line2854"></a>				$this->checkInterlaceImage($this->isInterlace);
<a name="line2855"></a>				if (imagetypes() & IMG_PNG)
<a name="line2856"></a>				{
<a name="line2857"></a>					imagepng($this->imageResized, $savePath, $invertScaleQuality);
<a name="line2858"></a>				}
<a name="line2859"></a>				else
<a name="line2860"></a>				{
<a name="line2861"></a>					$error = 'png';
<a name="line2862"></a>				}
<a name="line2863"></a>				break;
<a name="line2864"></a>
<a name="line2865"></a>			case '.bmp':
<a name="line2866"></a>				file_put_contents($savePath, $this->GD2BMPstring($this->imageResized));
<a name="line2867"></a>				break;
<a name="line2868"></a>
<a name="line2869"></a>
<a name="line2870"></a>			// ... etc
<a name="line2871"></a>
<a name="line2872"></a>			default:
<a name="line2873"></a>				// *** No extension - No save.
<a name="line2874"></a>				$this->errorArray[] = 'This file type (' . $extension . ') is not supported. File not saved.';
<a name="line2875"></a>				break;
<a name="line2876"></a>		}
<a name="line2877"></a>
<a name="line2878"></a>		//imagedestroy($this->imageResized);
<a name="line2879"></a>
<a name="line2880"></a>		// *** Display error if a file type is not supported.
<a name="line2881"></a>		if ($error != '')
<a name="line2882"></a>		{
<a name="line2883"></a>			$this->errorArray[] = $error . ' support is NOT enabled. File not saved.';
<a name="line2884"></a>		}
<a name="line2885"></a>	}
<a name="line2886"></a>
<a name="line2887"></a>## --------------------------------------------------------
<a name="line2888"></a>
<a name="line2889"></a>	public function displayImage($fileType = 'jpg', $imageQuality = "100")
<a name="line2890"></a>		# Author:     Jarrod Oberto
<a name="line2891"></a>		# Date:       18-11-09
<a name="line2892"></a>		# Purpose:    Display images directly to the browser
<a name="line2893"></a>		# Param in:   The image type you want to display
<a name="line2894"></a>		# Param out:
<a name="line2895"></a>		# Reference:
<a name="line2896"></a>		# Notes:
<a name="line2897"></a>		#
<a name="line2898"></a>	{
<a name="line2899"></a>
<a name="line2900"></a>		if ( ! is_resource($this->imageResized))
<a name="line2901"></a>		{
<a name="line2902"></a>			if ($this->debug)
<a name="line2903"></a>			{
<a name="line2904"></a>				throw new Exception('saveImage: This is not a resource.');
<a name="line2905"></a>			}
<a name="line2906"></a>			else
<a name="line2907"></a>			{
<a name="line2908"></a>				throw new Exception();
<a name="line2909"></a>			}
<a name="line2910"></a>		}
<a name="line2911"></a>
<a name="line2912"></a>		switch ($fileType)
<a name="line2913"></a>		{
<a name="line2914"></a>			case 'jpg':
<a name="line2915"></a>			case 'jpeg':
<a name="line2916"></a>				header('Content-type: image/jpeg');
<a name="line2917"></a>				imagejpeg($this->imageResized, '', $imageQuality);
<a name="line2918"></a>				break;
<a name="line2919"></a>			case 'gif':
<a name="line2920"></a>				header('Content-type: image/gif');
<a name="line2921"></a>				imagegif($this->imageResized);
<a name="line2922"></a>				break;
<a name="line2923"></a>			case 'png':
<a name="line2924"></a>				header('Content-type: image/png');
<a name="line2925"></a>
<a name="line2926"></a>				// *** Scale quality from 0-100 to 0-9
<a name="line2927"></a>				$scaleQuality = round(($imageQuality / 100) * 9);
<a name="line2928"></a>
<a name="line2929"></a>				// *** Invert qualit setting as 0 is best, not 9
<a name="line2930"></a>				$invertScaleQuality = 9 - $scaleQuality;
<a name="line2931"></a>
<a name="line2932"></a>				imagepng($this->imageResized, '', $invertScaleQuality);
<a name="line2933"></a>				break;
<a name="line2934"></a>			case 'bmp':
<a name="line2935"></a>				echo 'bmp file format is not supported.';
<a name="line2936"></a>				break;
<a name="line2937"></a>
<a name="line2938"></a>			// ... etc
<a name="line2939"></a>
<a name="line2940"></a>			default:
<a name="line2941"></a>				// *** No extension - No save.
<a name="line2942"></a>				break;
<a name="line2943"></a>		}
<a name="line2944"></a>
<a name="line2945"></a>
<a name="line2946"></a>		//imagedestroy($this->imageResized);
<a name="line2947"></a>	}
<a name="line2948"></a>
<a name="line2949"></a>## --------------------------------------------------------
<a name="line2950"></a>
<a name="line2951"></a>	public function setTransparency($bool)
<a name="line2952"></a>		# Sep 2011
<a name="line2953"></a>	{
<a name="line2954"></a>		$this->keepTransparency = $bool;
<a name="line2955"></a>	}
<a name="line2956"></a>
<a name="line2957"></a>## --------------------------------------------------------
<a name="line2958"></a>
<a name="line2959"></a>	public function setFillColor($value)
<a name="line2960"></a>		# Sep 2011
<a name="line2961"></a>		# Param in:   (mixed) $value: (array) Could be an array of RGB
<a name="line2962"></a>		#               (str) Could be hex #ffffff or #fff, fff, ffffff
<a name="line2963"></a>		#
<a name="line2964"></a>		# If the keepTransparency is set to false, then no transparency is to be used.
<a name="line2965"></a>		# This is ideal when you want to save as jpg.
<a name="line2966"></a>		#
<a name="line2967"></a>		# this method allows you to set the background color to use instead of
<a name="line2968"></a>		# transparency.
<a name="line2969"></a>		#
<a name="line2970"></a>	{
<a name="line2971"></a>		$colorArray = $this->formatColor($value);
<a name="line2972"></a>		$this->fillColorArray = $colorArray;
<a name="line2973"></a>	}
<a name="line2974"></a>
<a name="line2975"></a>## --------------------------------------------------------
<a name="line2976"></a>
<a name="line2977"></a>	public function setCropFromTop($value)
<a name="line2978"></a>		# Sep 2011
<a name="line2979"></a>	{
<a name="line2980"></a>		$this->cropFromTopPercent = $value;
<a name="line2981"></a>	}
<a name="line2982"></a>
<a name="line2983"></a>## --------------------------------------------------------
<a name="line2984"></a>
<a name="line2985"></a>	public function testGDInstalled()
<a name="line2986"></a>		# Author:     Jarrod Oberto
<a name="line2987"></a>		# Date:       27-02-08
<a name="line2988"></a>		# Purpose:    Test to see if GD is installed
<a name="line2989"></a>		# Param in:   n/a
<a name="line2990"></a>		# Param out:  (bool) True is gd extension loaded otherwise false
<a name="line2991"></a>		# Reference:
<a name="line2992"></a>		# Notes:
<a name="line2993"></a>		#
<a name="line2994"></a>	{
<a name="line2995"></a>		if (extension_loaded('gd') && function_exists('gd_info'))
<a name="line2996"></a>		{
<a name="line2997"></a>			$gdInstalled = true;
<a name="line2998"></a>		}
<a name="line2999"></a>		else
<a name="line3000"></a>		{
<a name="line3001"></a>			$gdInstalled = false;
<a name="line3002"></a>		}
<a name="line3003"></a>
<a name="line3004"></a>		return $gdInstalled;
<a name="line3005"></a>	}
<a name="line3006"></a>
<a name="line3007"></a>## --------------------------------------------------------
<a name="line3008"></a>
<a name="line3009"></a>	public function testEXIFInstalled()
<a name="line3010"></a>		# Author:     Jarrod Oberto
<a name="line3011"></a>		# Date:       08-05-11
<a name="line3012"></a>		# Purpose:    Test to see if EXIF is installed
<a name="line3013"></a>		# Param in:   n/a
<a name="line3014"></a>		# Param out:  (bool) True is exif extension loaded otherwise false
<a name="line3015"></a>		# Reference:
<a name="line3016"></a>		# Notes:
<a name="line3017"></a>		#
<a name="line3018"></a>	{
<a name="line3019"></a>		if (extension_loaded('exif'))
<a name="line3020"></a>		{
<a name="line3021"></a>			$exifInstalled = true;
<a name="line3022"></a>		}
<a name="line3023"></a>		else
<a name="line3024"></a>		{
<a name="line3025"></a>			$exifInstalled = false;
<a name="line3026"></a>		}
<a name="line3027"></a>
<a name="line3028"></a>		return $exifInstalled;
<a name="line3029"></a>	}
<a name="line3030"></a>
<a name="line3031"></a>## --------------------------------------------------------
<a name="line3032"></a>
<a name="line3033"></a>	public function testIsImage($image)
<a name="line3034"></a>		# Author:     Jarrod Oberto
<a name="line3035"></a>		# Date:       27-02-08
<a name="line3036"></a>		# Purpose:    Test if file is an image
<a name="line3037"></a>		# Param in:   n/a
<a name="line3038"></a>		# Param out:  n/a
<a name="line3039"></a>		# Reference:
<a name="line3040"></a>		# Notes:
<a name="line3041"></a>		#
<a name="line3042"></a>	{
<a name="line3043"></a>		if ($image)
<a name="line3044"></a>		{
<a name="line3045"></a>			$fileIsImage = true;
<a name="line3046"></a>		}
<a name="line3047"></a>		else
<a name="line3048"></a>		{
<a name="line3049"></a>			$fileIsImage = false;
<a name="line3050"></a>		}
<a name="line3051"></a>
<a name="line3052"></a>		return $fileIsImage;
<a name="line3053"></a>	}
<a name="line3054"></a>
<a name="line3055"></a>## --------------------------------------------------------
<a name="line3056"></a>
<a name="line3057"></a>	public function testFunct()
<a name="line3058"></a>		# Author:     Jarrod Oberto
<a name="line3059"></a>		# Date:       27-02-08
<a name="line3060"></a>		# Purpose:    Test Function
<a name="line3061"></a>		# Param in:   n/a
<a name="line3062"></a>		# Param out:  n/a
<a name="line3063"></a>		# Reference:
<a name="line3064"></a>		# Notes:
<a name="line3065"></a>		#
<a name="line3066"></a>	{
<a name="line3067"></a>		echo $this->height;
<a name="line3068"></a>	}
<a name="line3069"></a>
<a name="line3070"></a>## --------------------------------------------------------
<a name="line3071"></a>
<a name="line3072"></a>	public function setForceStretch($value)
<a name="line3073"></a>		# Author:     Jarrod Oberto
<a name="line3074"></a>		# Date:       23-12-10
<a name="line3075"></a>		# Purpose:
<a name="line3076"></a>		# Param in:   (bool) $value
<a name="line3077"></a>		# Param out:  n/a
<a name="line3078"></a>		# Reference:
<a name="line3079"></a>		# Notes:
<a name="line3080"></a>		#
<a name="line3081"></a>	{
<a name="line3082"></a>		$this->forceStretch = $value;
<a name="line3083"></a>	}
<a name="line3084"></a>
<a name="line3085"></a>## --------------------------------------------------------
<a name="line3086"></a>
<a name="line3087"></a>	public function setFile($fileName)
<a name="line3088"></a>		# Author:     Jarrod Oberto
<a name="line3089"></a>		# Date:       28-02-08
<a name="line3090"></a>		# Purpose:
<a name="line3091"></a>		# Param in:   n/a
<a name="line3092"></a>		# Param out:  n/a
<a name="line3093"></a>		# Reference:
<a name="line3094"></a>		# Notes:
<a name="line3095"></a>		#
<a name="line3096"></a>	{
<a name="line3097"></a>		self::__construct($fileName);
<a name="line3098"></a>	}
<a name="line3099"></a>
<a name="line3100"></a>## --------------------------------------------------------
<a name="line3101"></a>
<a name="line3102"></a>	public function getFileName()
<a name="line3103"></a>		# Author:     Jarrod Oberto
<a name="line3104"></a>		# Date:       10-09-08
<a name="line3105"></a>		# Purpose:
<a name="line3106"></a>		# Param in:   n/a
<a name="line3107"></a>		# Param out:  n/a
<a name="line3108"></a>		# Reference:
<a name="line3109"></a>		# Notes:
<a name="line3110"></a>		#
<a name="line3111"></a>	{
<a name="line3112"></a>		return $this->fileName;
<a name="line3113"></a>	}
<a name="line3114"></a>
<a name="line3115"></a>## --------------------------------------------------------
<a name="line3116"></a>
<a name="line3117"></a>	public function getHeight()
<a name="line3118"></a>	{
<a name="line3119"></a>		return $this->height;
<a name="line3120"></a>	}
<a name="line3121"></a>
<a name="line3122"></a>## --------------------------------------------------------
<a name="line3123"></a>
<a name="line3124"></a>	public function getWidth()
<a name="line3125"></a>	{
<a name="line3126"></a>		return $this->width;
<a name="line3127"></a>	}
<a name="line3128"></a>
<a name="line3129"></a>## --------------------------------------------------------
<a name="line3130"></a>
<a name="line3131"></a>	public function getOriginalHeight()
<a name="line3132"></a>	{
<a name="line3133"></a>		return $this->heightOriginal;
<a name="line3134"></a>	}
<a name="line3135"></a>
<a name="line3136"></a>## --------------------------------------------------------
<a name="line3137"></a>
<a name="line3138"></a>	public function getOriginalWidth()
<a name="line3139"></a>	{
<a name="line3140"></a>		return $this->widthOriginal;
<a name="line3141"></a>	}
<a name="line3142"></a>
<a name="line3143"></a>## --------------------------------------------------------
<a name="line3144"></a>
<a name="line3145"></a>	public function getErrors()
<a name="line3146"></a>		# Author:     Jarrod Oberto
<a name="line3147"></a>		# Date:       19-11-09
<a name="line3148"></a>		# Purpose:    Returns the error array
<a name="line3149"></a>		# Param in:   n/a
<a name="line3150"></a>		# Param out:  Array of errors
<a name="line3151"></a>		# Reference:
<a name="line3152"></a>		# Notes:
<a name="line3153"></a>		#
<a name="line3154"></a>	{
<a name="line3155"></a>		return $this->errorArray;
<a name="line3156"></a>	}
<a name="line3157"></a>
<a name="line3158"></a>## --------------------------------------------------------
<a name="line3159"></a>
<a name="line3160"></a>	private function checkInterlaceImage($isEnabled)
<a name="line3161"></a>		# jpg will use progressive (they don't use interace)
<a name="line3162"></a>	{
<a name="line3163"></a>		if ($isEnabled)
<a name="line3164"></a>		{
<a name="line3165"></a>			imageinterlace($this->imageResized, $isEnabled);
<a name="line3166"></a>		}
<a name="line3167"></a>	}
<a name="line3168"></a>
<a name="line3169"></a>## --------------------------------------------------------
<a name="line3170"></a>
<a name="line3171"></a>	protected function formatColor($value)
<a name="line3172"></a>		# Author:     Jarrod Oberto
<a name="line3173"></a>		# Date:       09-05-11
<a name="line3174"></a>		# Purpose:    Determine color method passed in and return color as RGB
<a name="line3175"></a>		# Param in:   (mixed) $value: (array) Could be an array of RGB
<a name="line3176"></a>		#               (str) Could be hex #ffffff or #fff, fff, ffffff
<a name="line3177"></a>		# Param out:
<a name="line3178"></a>		# Reference:
<a name="line3179"></a>		# Notes:
<a name="line3180"></a>		#
<a name="line3181"></a>	{
<a name="line3182"></a>		$rgbArray = array();
<a name="line3183"></a>
<a name="line3184"></a>		// *** If it's an array it should be R, G, B
<a name="line3185"></a>		if (is_array($value))
<a name="line3186"></a>		{
<a name="line3187"></a>
<a name="line3188"></a>			if (key($value) == 0 && count($value) == 3)
<a name="line3189"></a>			{
<a name="line3190"></a>
<a name="line3191"></a>				$rgbArray['r'] = $value[0];
<a name="line3192"></a>				$rgbArray['g'] = $value[1];
<a name="line3193"></a>				$rgbArray['b'] = $value[2];
<a name="line3194"></a>
<a name="line3195"></a>			}
<a name="line3196"></a>			else
<a name="line3197"></a>			{
<a name="line3198"></a>				$rgbArray = $value;
<a name="line3199"></a>			}
<a name="line3200"></a>		}
<a name="line3201"></a>		else
<a name="line3202"></a>		{
<a name="line3203"></a>			if (fix_strtolower($value) == 'transparent')
<a name="line3204"></a>			{
<a name="line3205"></a>
<a name="line3206"></a>				$rgbArray = array(
<a name="line3207"></a>					'r' => 255,
<a name="line3208"></a>					'g' => 255,
<a name="line3209"></a>					'b' => 255,
<a name="line3210"></a>					'a' => 127
<a name="line3211"></a>				);
<a name="line3212"></a>
<a name="line3213"></a>			}
<a name="line3214"></a>			else
<a name="line3215"></a>			{
<a name="line3216"></a>
<a name="line3217"></a>				// *** ...Else it should be hex. Let's make it RGB
<a name="line3218"></a>				$rgbArray = $this->hex2dec($value);
<a name="line3219"></a>			}
<a name="line3220"></a>		}
<a name="line3221"></a>
<a name="line3222"></a>		return $rgbArray;
<a name="line3223"></a>	}
<a name="line3224"></a>
<a name="line3225"></a>	## --------------------------------------------------------
<a name="line3226"></a>
<a name="line3227"></a>	function hex2dec($hex)
<a name="line3228"></a>		# Purpose:  Convert #hex color to RGB
<a name="line3229"></a>	{
<a name="line3230"></a>		$color = str_replace('#', '', $hex);
<a name="line3231"></a>
<a name="line3232"></a>		if (strlen($color) == 3)
<a name="line3233"></a>		{
<a name="line3234"></a>			$color = $color . $color;
<a name="line3235"></a>		}
<a name="line3236"></a>
<a name="line3237"></a>		$rgb = array(
<a name="line3238"></a>			'r' => hexdec(substr($color, 0, 2)),
<a name="line3239"></a>			'g' => hexdec(substr($color, 2, 2)),
<a name="line3240"></a>			'b' => hexdec(substr($color, 4, 2)),
<a name="line3241"></a>			'a' => 0
<a name="line3242"></a>		);
<a name="line3243"></a>
<a name="line3244"></a>		return $rgb;
<a name="line3245"></a>	}
<a name="line3246"></a>
<a name="line3247"></a>	## --------------------------------------------------------
<a name="line3248"></a>
<a name="line3249"></a>	private function createImageColor($colorArray)
<a name="line3250"></a>	{
<a name="line3251"></a>		$r = $colorArray['r'];
<a name="line3252"></a>		$g = $colorArray['g'];
<a name="line3253"></a>		$b = $colorArray['b'];
<a name="line3254"></a>
<a name="line3255"></a>		return imagecolorallocate($this->imageResized, $r, $g, $b);
<a name="line3256"></a>	}
<a name="line3257"></a>
<a name="line3258"></a>	## --------------------------------------------------------
<a name="line3259"></a>
<a name="line3260"></a>	private function testColorExists($colorArray)
<a name="line3261"></a>	{
<a name="line3262"></a>		$r = $colorArray['r'];
<a name="line3263"></a>		$g = $colorArray['g'];
<a name="line3264"></a>		$b = $colorArray['b'];
<a name="line3265"></a>
<a name="line3266"></a>		if (imagecolorexact($this->imageResized, $r, $g, $b) == -1)
<a name="line3267"></a>		{
<a name="line3268"></a>			return false;
<a name="line3269"></a>		}
<a name="line3270"></a>		else
<a name="line3271"></a>		{
<a name="line3272"></a>			return true;
<a name="line3273"></a>		}
<a name="line3274"></a>	}
<a name="line3275"></a>
<a name="line3276"></a>	## --------------------------------------------------------
<a name="line3277"></a>
<a name="line3278"></a>	private function findUnusedGreen()
<a name="line3279"></a>		# Purpose:  We find a green color suitable to use like green-screen effect.
<a name="line3280"></a>		#     Therefore, the color must not exist in the image.
<a name="line3281"></a>	{
<a name="line3282"></a>		$green = 255;
<a name="line3283"></a>
<a name="line3284"></a>		do
<a name="line3285"></a>		{
<a name="line3286"></a>
<a name="line3287"></a>			$greenChroma = array( 0, $green, 0 );
<a name="line3288"></a>			$colorArray = $this->formatColor($greenChroma);
<a name="line3289"></a>			$match = $this->testColorExists($colorArray);
<a name="line3290"></a>			$green--;
<a name="line3291"></a>
<a name="line3292"></a>		} while ($match == false && $green > 0);
<a name="line3293"></a>
<a name="line3294"></a>		// *** If no match, just bite the bullet and use green value of 255
<a name="line3295"></a>		if ( ! $match)
<a name="line3296"></a>		{
<a name="line3297"></a>			$greenChroma = array( 0, $green, 0 );
<a name="line3298"></a>		}
<a name="line3299"></a>
<a name="line3300"></a>		return $greenChroma;
<a name="line3301"></a>	}
<a name="line3302"></a>
<a name="line3303"></a>	## --------------------------------------------------------
<a name="line3304"></a>
<a name="line3305"></a>	private function findUnusedBlue()
<a name="line3306"></a>		# Purpose:  We find a green color suitable to use like green-screen effect.
<a name="line3307"></a>		#     Therefore, the color must not exist in the image.
<a name="line3308"></a>	{
<a name="line3309"></a>		$blue = 255;
<a name="line3310"></a>
<a name="line3311"></a>		do
<a name="line3312"></a>		{
<a name="line3313"></a>
<a name="line3314"></a>			$blueChroma = array( 0, 0, $blue );
<a name="line3315"></a>			$colorArray = $this->formatColor($blueChroma);
<a name="line3316"></a>			$match = $this->testColorExists($colorArray);
<a name="line3317"></a>			$blue--;
<a name="line3318"></a>
<a name="line3319"></a>		} while ($match == false && $blue > 0);
<a name="line3320"></a>
<a name="line3321"></a>		// *** If no match, just bite the bullet and use blue value of 255
<a name="line3322"></a>		if ( ! $match)
<a name="line3323"></a>		{
<a name="line3324"></a>			$blueChroma = array( 0, 0, $blue );
<a name="line3325"></a>		}
<a name="line3326"></a>
<a name="line3327"></a>		return $blueChroma;
<a name="line3328"></a>	}
<a name="line3329"></a>
<a name="line3330"></a>	## --------------------------------------------------------
<a name="line3331"></a>
<a name="line3332"></a>	private function invertTransparency($value, $originalMax, $invert = true)
<a name="line3333"></a>		# Purpose:  This does two things:
<a name="line3334"></a>		#       1) Convert the range from 0-127 to 0-100
<a name="line3335"></a>		#       2) Inverts value to 100 is not transparent while 0 is fully
<a name="line3336"></a>		#          transparent (like Photoshop)
<a name="line3337"></a>	{
<a name="line3338"></a>		// *** Test max range
<a name="line3339"></a>		if ($value > $originalMax)
<a name="line3340"></a>		{
<a name="line3341"></a>			$value = $originalMax;
<a name="line3342"></a>		}
<a name="line3343"></a>
<a name="line3344"></a>		// *** Test min range
<a name="line3345"></a>		if ($value < 0)
<a name="line3346"></a>		{
<a name="line3347"></a>			$value = 0;
<a name="line3348"></a>		}
<a name="line3349"></a>
<a name="line3350"></a>		if ($invert)
<a name="line3351"></a>		{
<a name="line3352"></a>			return $originalMax - (($value / 100) * $originalMax);
<a name="line3353"></a>		}
<a name="line3354"></a>		else
<a name="line3355"></a>		{
<a name="line3356"></a>			return ($value / 100) * $originalMax;
<a name="line3357"></a>		}
<a name="line3358"></a>	}
<a name="line3359"></a>
<a name="line3360"></a>	## --------------------------------------------------------
<a name="line3361"></a>
<a name="line3362"></a>	private function transparentImage($src)
<a name="line3363"></a>	{
<a name="line3364"></a>		// *** making images with white bg transparent
<a name="line3365"></a>		$r1 = 0;
<a name="line3366"></a>		$g1 = 255;
<a name="line3367"></a>		$b1 = 0;
<a name="line3368"></a>		for ($x = 0; $x < imagesx($src); ++$x)
<a name="line3369"></a>		{
<a name="line3370"></a>			for ($y = 0; $y < imagesy($src); ++$y)
<a name="line3371"></a>			{
<a name="line3372"></a>				$color = imagecolorat($src, $x, $y);
<a name="line3373"></a>				$r = ($color >> 16) & 0xFF;
<a name="line3374"></a>				$g = ($color >> 8) & 0xFF;
<a name="line3375"></a>				$b = $color & 0xFF;
<a name="line3376"></a>				for ($i = 0; $i < 270; $i++)
<a name="line3377"></a>				{
<a name="line3378"></a>					//if ($r . $g . $b == ($r1 + $i) . ($g1 + $i) . ($b1 + $i)) {
<a name="line3379"></a>					if ($r == 0 && $g == 255 && $b == 0)
<a name="line3380"></a>					{
<a name="line3381"></a>						//if ($g == 255) {
<a name="line3382"></a>						$trans_colour = imagecolorallocatealpha($src, 0, 0, 0, 127);
<a name="line3383"></a>						imagefill($src, $x, $y, $trans_colour);
<a name="line3384"></a>					}
<a name="line3385"></a>				}
<a name="line3386"></a>			}
<a name="line3387"></a>		}
<a name="line3388"></a>
<a name="line3389"></a>		return $src;
<a name="line3390"></a>	}
<a name="line3391"></a>
<a name="line3392"></a>	## --------------------------------------------------------
<a name="line3393"></a>
<a name="line3394"></a>	function checkStringStartsWith($needle, $haystack)
<a name="line3395"></a>		# Check if a string starts with a specific pattern
<a name="line3396"></a>	{
<a name="line3397"></a>		return (substr($haystack, 0, strlen($needle)) == $needle);
<a name="line3398"></a>	}
<a name="line3399"></a>
<a name="line3400"></a>
<a name="line3401"></a>	/*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*-
<a name="line3402"></a>  BMP SUPPORT (SAVING) - James Heinrich
<a name="line3403"></a>*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*/
<a name="line3404"></a>
<a name="line3405"></a>	private function GD2BMPstring(&$gd_image)
<a name="line3406"></a>		# Author:     James Heinrich
<a name="line3407"></a>		# Purpose:    Save file as type bmp
<a name="line3408"></a>		# Param in:   The image canvas (passed as ref)
<a name="line3409"></a>		# Param out:
<a name="line3410"></a>		# Reference:
<a name="line3411"></a>		# Notes:    This code was stripped out of two external files
<a name="line3412"></a>		#       (phpthumb.bmp.php,phpthumb.functions.php) and added below to
<a name="line3413"></a>		#       avoid dependancies.
<a name="line3414"></a>		#
<a name="line3415"></a>	{
<a name="line3416"></a>		$imageX = ImageSX($gd_image);
<a name="line3417"></a>		$imageY = ImageSY($gd_image);
<a name="line3418"></a>
<a name="line3419"></a>		$BMP = '';
<a name="line3420"></a>		for ($y = ($imageY - 1); $y >= 0; $y--)
<a name="line3421"></a>		{
<a name="line3422"></a>			$thisline = '';
<a name="line3423"></a>			for ($x = 0; $x < $imageX; $x++)
<a name="line3424"></a>			{
<a name="line3425"></a>				$argb = $this->GetPixelColor($gd_image, $x, $y);
<a name="line3426"></a>				$thisline .= chr($argb['blue']) . chr($argb['green']) . chr($argb['red']);
<a name="line3427"></a>			}
<a name="line3428"></a>			while (strlen($thisline) % 4)
<a name="line3429"></a>			{
<a name="line3430"></a>				$thisline .= "\x00";
<a name="line3431"></a>			}
<a name="line3432"></a>			$BMP .= $thisline;
<a name="line3433"></a>		}
<a name="line3434"></a>
<a name="line3435"></a>		$bmpSize = strlen($BMP) + 14 + 40;
<a name="line3436"></a>		// BITMAPFILEHEADER [14 bytes] - http://msdn.microsoft.com/library/en-us/gdi/bitmaps_62uq.asp
<a name="line3437"></a>		$BITMAPFILEHEADER = 'BM';                                    // WORD    bfType;
<a name="line3438"></a>		$BITMAPFILEHEADER .= $this->LittleEndian2String($bmpSize, 4); // DWORD   bfSize;
<a name="line3439"></a>		$BITMAPFILEHEADER .= $this->LittleEndian2String(0, 2); // WORD    bfReserved1;
<a name="line3440"></a>		$BITMAPFILEHEADER .= $this->LittleEndian2String(0, 2); // WORD    bfReserved2;
<a name="line3441"></a>		$BITMAPFILEHEADER .= $this->LittleEndian2String(54, 4); // DWORD   bfOffBits;
<a name="line3442"></a>
<a name="line3443"></a>		// BITMAPINFOHEADER - [40 bytes] http://msdn.microsoft.com/library/en-us/gdi/bitmaps_1rw2.asp
<a name="line3444"></a>		$BITMAPINFOHEADER = $this->LittleEndian2String(40, 4); // DWORD  biSize;
<a name="line3445"></a>		$BITMAPINFOHEADER .= $this->LittleEndian2String($imageX, 4); // LONG   biWidth;
<a name="line3446"></a>		$BITMAPINFOHEADER .= $this->LittleEndian2String($imageY, 4); // LONG   biHeight;
<a name="line3447"></a>		$BITMAPINFOHEADER .= $this->LittleEndian2String(1, 2); // WORD   biPlanes;
<a name="line3448"></a>		$BITMAPINFOHEADER .= $this->LittleEndian2String(24, 2); // WORD   biBitCount;
<a name="line3449"></a>		$BITMAPINFOHEADER .= $this->LittleEndian2String(0, 4); // DWORD  biCompression;
<a name="line3450"></a>		$BITMAPINFOHEADER .= $this->LittleEndian2String(0, 4); // DWORD  biSizeImage;
<a name="line3451"></a>		$BITMAPINFOHEADER .= $this->LittleEndian2String(2835, 4); // LONG   biXPelsPerMeter;
<a name="line3452"></a>		$BITMAPINFOHEADER .= $this->LittleEndian2String(2835, 4); // LONG   biYPelsPerMeter;
<a name="line3453"></a>		$BITMAPINFOHEADER .= $this->LittleEndian2String(0, 4); // DWORD  biClrUsed;
<a name="line3454"></a>		$BITMAPINFOHEADER .= $this->LittleEndian2String(0, 4); // DWORD  biClrImportant;
<a name="line3455"></a>
<a name="line3456"></a>		return $BITMAPFILEHEADER . $BITMAPINFOHEADER . $BMP;
<a name="line3457"></a>	}
<a name="line3458"></a>
<a name="line3459"></a>## --------------------------------------------------------
<a name="line3460"></a>
<a name="line3461"></a>	private function GetPixelColor(&$img, $x, $y)
<a name="line3462"></a>		# Author:     James Heinrich
<a name="line3463"></a>		# Purpose:
<a name="line3464"></a>		# Param in:
<a name="line3465"></a>		# Param out:
<a name="line3466"></a>		# Reference:
<a name="line3467"></a>		# Notes:
<a name="line3468"></a>		#
<a name="line3469"></a>	{
<a name="line3470"></a>		if ( ! is_resource($img))
<a name="line3471"></a>		{
<a name="line3472"></a>			return false;
<a name="line3473"></a>		}
<a name="line3474"></a>
<a name="line3475"></a>		return @ImageColorsForIndex($img, @ImageColorAt($img, $x, $y));
<a name="line3476"></a>	}
<a name="line3477"></a>
<a name="line3478"></a>## --------------------------------------------------------
<a name="line3479"></a>
<a name="line3480"></a>	private function LittleEndian2String($number, $minbytes = 1)
<a name="line3481"></a>		# Author:     James Heinrich
<a name="line3482"></a>		# Purpose:    BMP SUPPORT (SAVING)
<a name="line3483"></a>		# Param in:
<a name="line3484"></a>		# Param out:
<a name="line3485"></a>		# Reference:
<a name="line3486"></a>		# Notes:
<a name="line3487"></a>		#
<a name="line3488"></a>	{
<a name="line3489"></a>		$intstring = '';
<a name="line3490"></a>		while ($number > 0)
<a name="line3491"></a>		{
<a name="line3492"></a>			$intstring = $intstring . chr($number & 255);
<a name="line3493"></a>			$number >>= 8;
<a name="line3494"></a>		}
<a name="line3495"></a>
<a name="line3496"></a>		return str_pad($intstring, $minbytes, "\x00", STR_PAD_RIGHT);
<a name="line3497"></a>	}
<a name="line3498"></a>
<a name="line3499"></a>
<a name="line3500"></a>	/*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*-
<a name="line3501"></a>  BMP SUPPORT (READING)
<a name="line3502"></a>*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*/
<a name="line3503"></a>
<a name="line3504"></a>	private function ImageCreateFromBMP($filename)
<a name="line3505"></a>		# Author:     DHKold
<a name="line3506"></a>		# Date:     The 15th of June 2005
<a name="line3507"></a>		# Version:    2.0B
<a name="line3508"></a>		# Purpose:    To create an image from a BMP file.
<a name="line3509"></a>		# Param in:   BMP file to open.
<a name="line3510"></a>		# Param out:  Return a resource like the other ImageCreateFrom functions
<a name="line3511"></a>		# Reference:  http://us3.php.net/manual/en/function.imagecreate.php#53879
<a name="line3512"></a>		# Bug fix:    Author:   domelca at terra dot es
<a name="line3513"></a>		#       Date:   06 March 2008
<a name="line3514"></a>		#       Fix:    Correct 16bit BMP support
<a name="line3515"></a>		# Notes:
<a name="line3516"></a>		#
<a name="line3517"></a>	{
<a name="line3518"></a>
<a name="line3519"></a>		//Ouverture du fichier en mode binaire
<a name="line3520"></a>		if ( ! $f1 = fopen($filename, "rb"))
<a name="line3521"></a>		{
<a name="line3522"></a>			return false;
<a name="line3523"></a>		}
<a name="line3524"></a>
<a name="line3525"></a>		//1 : Chargement des enttes FICHIER
<a name="line3526"></a>		$FILE = unpack("vfile_type/Vfile_size/Vreserved/Vbitmap_offset", fread($f1, 14));
<a name="line3527"></a>		if ($FILE['file_type'] != 19778)
<a name="line3528"></a>		{
<a name="line3529"></a>			return false;
<a name="line3530"></a>		}
<a name="line3531"></a>
<a name="line3532"></a>		//2 : Chargement des enttes BMP
<a name="line3533"></a>		$BMP = unpack('Vheader_size/Vwidth/Vheight/vplanes/vbits_per_pixel' .
<a name="line3534"></a>			'/Vcompression/Vsize_bitmap/Vhoriz_resolution' .
<a name="line3535"></a>			'/Vvert_resolution/Vcolors_used/Vcolors_important', fread($f1, 40));
<a name="line3536"></a>		$BMP['colors'] = pow(2, $BMP['bits_per_pixel']);
<a name="line3537"></a>
<a name="line3538"></a>		if ($BMP['size_bitmap'] == 0)
<a name="line3539"></a>		{
<a name="line3540"></a>			$BMP['size_bitmap'] = $FILE['file_size'] - $FILE['bitmap_offset'];
<a name="line3541"></a>		}
<a name="line3542"></a>
<a name="line3543"></a>		$BMP['bytes_per_pixel'] = $BMP['bits_per_pixel'] / 8;
<a name="line3544"></a>		$BMP['bytes_per_pixel2'] = ceil($BMP['bytes_per_pixel']);
<a name="line3545"></a>		$BMP['decal'] = ($BMP['width'] * $BMP['bytes_per_pixel'] / 4);
<a name="line3546"></a>		$BMP['decal'] -= floor($BMP['width'] * $BMP['bytes_per_pixel'] / 4);
<a name="line3547"></a>		$BMP['decal'] = 4 - (4 * $BMP['decal']);
<a name="line3548"></a>
<a name="line3549"></a>		if ($BMP['decal'] == 4)
<a name="line3550"></a>		{
<a name="line3551"></a>			$BMP['decal'] = 0;
<a name="line3552"></a>		}
<a name="line3553"></a>
<a name="line3554"></a>		//3 : Chargement des couleurs de la palette
<a name="line3555"></a>		$PALETTE = array();
<a name="line3556"></a>		if ($BMP['colors'] < 16777216)
<a name="line3557"></a>		{
<a name="line3558"></a>			$PALETTE = unpack('V' . $BMP['colors'], fread($f1, $BMP['colors'] * 4));
<a name="line3559"></a>		}
<a name="line3560"></a>
<a name="line3561"></a>		//4 : Cration de l'image
<a name="line3562"></a>		$IMG = fread($f1, $BMP['size_bitmap']);
<a name="line3563"></a>		$VIDE = chr(0);
<a name="line3564"></a>
<a name="line3565"></a>		$res = imagecreatetruecolor($BMP['width'], $BMP['height']);
<a name="line3566"></a>		$P = 0;
<a name="line3567"></a>		$Y = $BMP['height'] - 1;
<a name="line3568"></a>		while ($Y >= 0)
<a name="line3569"></a>		{
<a name="line3570"></a>			$X = 0;
<a name="line3571"></a>			while ($X < $BMP['width'])
<a name="line3572"></a>			{
<a name="line3573"></a>				if ($BMP['bits_per_pixel'] == 24)
<a name="line3574"></a>				{
<a name="line3575"></a>					$COLOR = unpack("V", substr($IMG, $P, 3) . $VIDE);
<a name="line3576"></a>				}
<a name="line3577"></a>				elseif ($BMP['bits_per_pixel'] == 16)
<a name="line3578"></a>				{
<a name="line3579"></a>
<a name="line3580"></a>					/*
<a name="line3581"></a>           * BMP 16bit fix
<a name="line3582"></a>           * =================
<a name="line3583"></a>           *
<a name="line3584"></a>           * Ref: http://us3.php.net/manual/en/function.imagecreate.php#81604
<a name="line3585"></a>           *
<a name="line3586"></a>           * Notes:
<a name="line3587"></a>           * "don't work with bmp 16 bits_per_pixel. change pixel
<a name="line3588"></a>           * generator for this."
<a name="line3589"></a>           *
<a name="line3590"></a>           */
<a name="line3591"></a>
<a name="line3592"></a>					// *** Original code (don't work)
<a name="line3593"></a>					//$COLOR = unpack("n",substr($IMG,$P,2));
<a name="line3594"></a>					//$COLOR[1] = $PALETTE[$COLOR[1]+1];
<a name="line3595"></a>
<a name="line3596"></a>					$COLOR = unpack("v", substr($IMG, $P, 2));
<a name="line3597"></a>					$blue = ($COLOR[1] & 0x001f) << 3;
<a name="line3598"></a>					$green = ($COLOR[1] & 0x07e0) >> 3;
<a name="line3599"></a>					$red = ($COLOR[1] & 0xf800) >> 8;
<a name="line3600"></a>					$COLOR[1] = $red * 65536 + $green * 256 + $blue;
<a name="line3601"></a>
<a name="line3602"></a>				}
<a name="line3603"></a>				elseif ($BMP['bits_per_pixel'] == 8)
<a name="line3604"></a>				{
<a name="line3605"></a>					$COLOR = unpack("n", $VIDE . substr($IMG, $P, 1));
<a name="line3606"></a>					$COLOR[1] = $PALETTE[ $COLOR[1] + 1 ];
<a name="line3607"></a>				}
<a name="line3608"></a>				elseif ($BMP['bits_per_pixel'] == 4)
<a name="line3609"></a>				{
<a name="line3610"></a>					$COLOR = unpack("n", $VIDE . substr($IMG, floor($P), 1));
<a name="line3611"></a>					if (($P * 2) % 2 == 0)
<a name="line3612"></a>					{
<a name="line3613"></a>						$COLOR[1] = ($COLOR[1] >> 4);
<a name="line3614"></a>					}
<a name="line3615"></a>					else
<a name="line3616"></a>					{
<a name="line3617"></a>						$COLOR[1] = ($COLOR[1] & 0x0F);
<a name="line3618"></a>					}
<a name="line3619"></a>					$COLOR[1] = $PALETTE[ $COLOR[1] + 1 ];
<a name="line3620"></a>				}
<a name="line3621"></a>				elseif ($BMP['bits_per_pixel'] == 1)
<a name="line3622"></a>				{
<a name="line3623"></a>					$COLOR = unpack("n", $VIDE . substr($IMG, floor($P), 1));
<a name="line3624"></a>					if (($P * 8) % 8 == 0)
<a name="line3625"></a>					{
<a name="line3626"></a>						$COLOR[1] = $COLOR[1] >> 7;
<a name="line3627"></a>					}
<a name="line3628"></a>					elseif (($P * 8) % 8 == 1)
<a name="line3629"></a>					{
<a name="line3630"></a>						$COLOR[1] = ($COLOR[1] & 0x40) >> 6;
<a name="line3631"></a>					}
<a name="line3632"></a>					elseif (($P * 8) % 8 == 2)
<a name="line3633"></a>					{
<a name="line3634"></a>						$COLOR[1] = ($COLOR[1] & 0x20) >> 5;
<a name="line3635"></a>					}
<a name="line3636"></a>					elseif (($P * 8) % 8 == 3)
<a name="line3637"></a>					{
<a name="line3638"></a>						$COLOR[1] = ($COLOR[1] & 0x10) >> 4;
<a name="line3639"></a>					}
<a name="line3640"></a>					elseif (($P * 8) % 8 == 4)
<a name="line3641"></a>					{
<a name="line3642"></a>						$COLOR[1] = ($COLOR[1] & 0x8) >> 3;
<a name="line3643"></a>					}
<a name="line3644"></a>					elseif (($P * 8) % 8 == 5)
<a name="line3645"></a>					{
<a name="line3646"></a>						$COLOR[1] = ($COLOR[1] & 0x4) >> 2;
<a name="line3647"></a>					}
<a name="line3648"></a>					elseif (($P * 8) % 8 == 6)
<a name="line3649"></a>					{
<a name="line3650"></a>						$COLOR[1] = ($COLOR[1] & 0x2) >> 1;
<a name="line3651"></a>					}
<a name="line3652"></a>					elseif (($P * 8) % 8 == 7)
<a name="line3653"></a>					{
<a name="line3654"></a>						$COLOR[1] = ($COLOR[1] & 0x1);
<a name="line3655"></a>					}
<a name="line3656"></a>					$COLOR[1] = $PALETTE[ $COLOR[1] + 1 ];
<a name="line3657"></a>				}
<a name="line3658"></a>				else
<a name="line3659"></a>				{
<a name="line3660"></a>					return false;
<a name="line3661"></a>				}
<a name="line3662"></a>
<a name="line3663"></a>				imagesetpixel($res, $X, $Y, $COLOR[1]);
<a name="line3664"></a>				$X++;
<a name="line3665"></a>				$P += $BMP['bytes_per_pixel'];
<a name="line3666"></a>			}
<a name="line3667"></a>
<a name="line3668"></a>			$Y--;
<a name="line3669"></a>			$P += $BMP['decal'];
<a name="line3670"></a>		}
<a name="line3671"></a>		//Fermeture du fichier
<a name="line3672"></a>		fclose($f1);
<a name="line3673"></a>
<a name="line3674"></a>		return $res;
<a name="line3675"></a>	}
<a name="line3676"></a>
<a name="line3677"></a>
<a name="line3678"></a>	/*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*-
<a name="line3679"></a>  PSD SUPPORT (READING)
<a name="line3680"></a>*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-**-*-*-*-*-*-*-*-*-*-*-*-*-*/
<a name="line3681"></a>
<a name="line3682"></a>	private function imagecreatefrompsd($fileName)
<a name="line3683"></a>		# Author:     Tim de Koning
<a name="line3684"></a>		# Version:    1.3
<a name="line3685"></a>		# Purpose:    To create an image from a PSD file.
<a name="line3686"></a>		# Param in:   PSD file to open.
<a name="line3687"></a>		# Param out:  Return a resource like the other ImageCreateFrom functions
<a name="line3688"></a>		# Reference:  http://www.kingsquare.nl/phppsdreader
<a name="line3689"></a>		# Notes:
<a name="line3690"></a>		#
<a name="line3691"></a>	{
<a name="line3692"></a>		if (file_exists($this->psdReaderPath))
<a name="line3693"></a>		{
<a name="line3694"></a>
<a name="line3695"></a>
<a name="line3696"></a>			include_once($this->psdReaderPath);
<a name="line3697"></a>
<a name="line3698"></a>			$psdReader = new PhpPsdReader($fileName);
<a name="line3699"></a>
<a name="line3700"></a>			if (isset($psdReader->infoArray['error']))
<a name="line3701"></a>			{
<a name="line3702"></a>				return '';
<a name="line3703"></a>			}
<a name="line3704"></a>			else
<a name="line3705"></a>			{
<a name="line3706"></a>				return $psdReader->getImage();
<a name="line3707"></a>			}
<a name="line3708"></a>		}
<a name="line3709"></a>		else
<a name="line3710"></a>		{
<a name="line3711"></a>			return false;
<a name="line3712"></a>		}
<a name="line3713"></a>	}
<a name="line3714"></a>
<a name="line3715"></a>## --------------------------------------------------------
<a name="line3716"></a>
<a name="line3717"></a>	public function __destruct()
<a name="line3718"></a>	{
<a name="line3719"></a>		if (is_resource($this->imageResized))
<a name="line3720"></a>		{
<a name="line3721"></a>			imagedestroy($this->imageResized);
<a name="line3722"></a>		}
<a name="line3723"></a>	}
<a name="line3724"></a>
<a name="line3725"></a>## --------------------------------------------------------
<a name="line3726"></a>
<a name="line3727"></a>}
<a name="line3728"></a>
<a name="line3729"></a>
<a name="line3730"></a>/*
<a name="line3731"></a> *    Example with some API calls (outdated):
<a name="line3732"></a> *
<a name="line3733"></a> *
<a name="line3734"></a> *      ===============================
<a name="line3735"></a> *      Compulsary
<a name="line3736"></a> *      ===============================
<a name="line3737"></a> *
<a name="line3738"></a> *      include("classes/resize_class.php");
<a name="line3739"></a> *
<a name="line3740"></a> *      // *** Initialise object
<a name="line3741"></a> *      $magicianObj = new resize('images/cars/large/a.jpg');
<a name="line3742"></a> *
<a name="line3743"></a> *      // *** Turn off stretching (optional)
<a name="line3744"></a> *      $magicianObj -> setForceStretch(false);
<a name="line3745"></a> *
<a name="line3746"></a> *      // *** Resize object
<a name="line3747"></a> *      $magicianObj -> resizeImage(150, 100, 0);
<a name="line3748"></a> *
<a name="line3749"></a> *      ===============================
<a name="line3750"></a> *      Image options - can run none, one, or all.
<a name="line3751"></a> *      ===============================
<a name="line3752"></a> *
<a name="line3753"></a> *      //  *** Add watermark
<a name="line3754"></a> *        $magicianObj -> addWatermark('stamp.png');
<a name="line3755"></a> *
<a name="line3756"></a> *          // *** Add text
<a name="line3757"></a> *      $magicianObj -> addText('testing...');
<a name="line3758"></a> *
<a name="line3759"></a> *      ===============================
<a name="line3760"></a> *      Output options - can run one, or the other, or both.
<a name="line3761"></a> *      ===============================
<a name="line3762"></a> *
<a name="line3763"></a> *      // *** Save image to disk
<a name="line3764"></a> *      $magicianObj -> saveImage('images/cars/large/b.jpg', 100);
<a name="line3765"></a> *
<a name="line3766"></a> *          // *** Or output to screen (params in can be jpg, gif, png)
<a name="line3767"></a> *      $magicianObj -> displayImage('png');
<a name="line3768"></a> *
<a name="line3769"></a> *      ===============================
<a name="line3770"></a> *      Return options - return errors. nice for debuggin.
<a name="line3771"></a> *      ===============================
<a name="line3772"></a> *
<a name="line3773"></a> *      // *** Return error array
<a name="line3774"></a> *      $errorArray = $magicianObj -> getErrors();
<a name="line3775"></a> *
<a name="line3776"></a> *
<a name="line3777"></a> *      ===============================
<a name="line3778"></a> *      Cleanup options - not really neccessary, but good practice
<a name="line3779"></a> *      ===============================
<a name="line3780"></a> *
<a name="line3781"></a> *      // *** Free used memory
<a name="line3782"></a> *      $magicianObj -> __destruct();
<a name="line3783"></a> */
<a name="line3784"></a></pre>
<div class="header">
<h1>RObo cosi header</h1>
<ul>
<li><a href="../overview-summary.html">Overview</a></li>
<li>Package</li><li>Class</li><li>Tree</li><li><a href="../overview-files.html">Files</a></li>
<li><a href="../deprecated-list.html">Deprecated</a></li>
<li><a href="../todo-list.html">Todo</a></li>
<li><a href="../index-all.html">Index</a></li>
</ul>
</div>

<div class="small_links">
<a href="../index.html" target="_top">Frames</a>
<a href="../source\filemanager\include\php_image_magician.php.html" target="_top">No frames</a>
</div>
<hr>

<p id="footer">This document was generated by <a href="http://peej.github.com/phpdoctor/">PHPDoctor: The PHP Documentation Creator</a></p>

</body>

</html>